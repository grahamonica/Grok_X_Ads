<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grok X Ads | Target Audience</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap');

    :root {
      --bg: #0b0b0b;
      --card: #101010;
      --raised: #141414;
      --ink: #f5f5f5;
      --muted: #9b9b9b;
      --border: #1f1f1f;
      --accent: #ffffff;
      --ghost: #191919;
      --shadow: 0 24px 120px rgba(0, 0, 0, 0.45);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at 20% 20%, #111 0%, #0a0a0a 35%, #050505 100%);
      color: var(--ink);
      font-family: 'Chirp', 'Space Grotesk', 'SF Pro Display', 'Neue Haas Grotesk', sans-serif;
      min-height: 100vh;
      letter-spacing: -0.01em;
    }

    a {
      color: var(--ink);
      text-decoration: none;
    }

    .frame {
      max-width: 1180px;
      margin: 0 auto;
      padding: 40px 24px 96px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 32px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo {
      width: 54px;
      height: 54px;
      background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
      border: 1px solid var(--border);
      border-radius: 14px;
      display: grid;
      place-items: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
    }

    .logo img {
      width: 30px;
      height: 30px;
    }

    .brand-label {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .brand-sub {
      font-size: 16px;
      color: var(--muted);
    }

    .status-chip {
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      font-size: 13px;
      color: var(--muted);
    }

    .hero {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .hero .headline {
      font-size: 36px;
      font-weight: 600;
      line-height: 1.15;
    }

    .hero .lede {
      color: var(--muted);
      font-size: 18px;
      line-height: 1.6;
      max-width: 620px;
    }

    .panel {
      background: linear-gradient(180deg, var(--raised), #0d0d0d);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 22px 20px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .panel::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.02);
      pointer-events: none;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .panel-title {
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .pill {
      font-size: 12px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--ink);
      background: var(--ghost);
    }

    form {
      display: grid;
      gap: 14px;
    }

    label {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .required {
      color: var(--ink);
      font-size: 12px;
      letter-spacing: 0.05em;
    }

    input[type="text"],
    input[type="url"],
    textarea,
    select {
      width: 100%;
      padding: 16px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--ghost);
      color: var(--ink);
      font-size: 17px;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #2d2d2d;
      box-shadow: 0 0 0 1px #2d2d2d;
    }

    textarea {
      resize: vertical;
      min-height: 110px;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      cursor: pointer;
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f9f9f9;
      color: #0b0b0b;
      font-weight: 600;
      font-size: 16px;
      letter-spacing: 0.02em;
      transition: transform 0.12s ease, box-shadow 0.2s ease, border 0.2s ease;
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(255, 255, 255, 0.08);
      border-color: #2a2a2a;
    }

    .ghost-btn {
      background: transparent;
      color: var(--ink);
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .note {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
      margin-top: 6px;
    }

    .hidden {
      display: none;
    }

    .alert {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #121212;
      color: var(--ink);
      font-size: 14px;
      margin-top: 6px;
    }

    .alert.error {
      border-color: #3a3a3a;
      color: #f3b7b7;
    }

    .alert.success {
      border-color: #2d2d2d;
      color: #c9f7c5;
    }

    .stack {
      display: grid;
      gap: 12px;
    }

    .chip-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 13px;
    }

    .chip-row span {
      padding: 6px 10px;
      border-radius: 10px;
      background: var(--ghost);
      border: 1px solid var(--border);
    }

    .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, #1d1d1d, transparent);
      margin: 20px 0;
      border: none;
    }

    .monospace {
      font-family: 'IBM Plex Mono', 'SFMono-Regular', Consolas, monospace;
      font-size: 13px;
    }

    .timeline {
      display: grid;
      gap: 14px;
      margin-top: 12px;
    }

    .tile {
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #0f0f0f;
      padding: 14px 14px 12px;
    }

    .tile h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      letter-spacing: 0.04em;
      color: var(--muted);
      text-transform: uppercase;
    }

    .tile strong {
      color: var(--ink);
    }

    .next-module {
      border: 1px dashed #2a2a2a;
      background: #0d0d0d;
    }

    .loader {
      width: 100%;
      height: 2px;
      background: #1f1f1f;
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }

    .loader::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, #ffffff, transparent);
      transform: translateX(-100%);
      animation: slide 1.8s infinite;
    }

    @keyframes slide {
      0% { transform: translateX(-100%); }
      50% { transform: translateX(40%); }
      100% { transform: translateX(120%); }
    }

    @media (max-width: 640px) {
      header {
        align-items: flex-start;
      }
      .actions {
        flex-direction: column;
        align-items: stretch;
      }
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="frame">
    <header>
      <div class="brand">
        <div class="logo" aria-label="xAI logo">
          <img src="/static/Xicon.jpg" alt="X">
        </div>
        <div class="brand-label">
          <div class="brand-title">Grok X Ads</div>
          <div class="brand-sub">Product → Demographics → Ad image</div>
        </div>
      </div>
    </header>



    <section id="pinnedRecap" class="panel hidden">
      <div class="panel-header">
        <div class="panel-title">Pinned target audience</div>
        <span class="pill monospace" id="recapBadge">locked</span>
      </div>
      <div class="timeline" id="recapTimeline"></div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Step 1 · Get demographics</div>
        <span class="pill"></span>
      </div>
      <form id="demographicForm" novalidate>
        <div>
          <label for="productUrl">Product URL <span class="required"></span></label>
          <input type="url" id="productUrl" name="productUrl" placeholder="https://example.com/product" required autocomplete="url">
        </div>
        <div>
          <label for="prompt">Describe this ad's target audience <span class="required"></span></label>
          <textarea id="prompt" name="prompt" placeholder="Who do you want to connect with?" required></textarea>
          <p class="note">W.</p>
        </div>
        <div class="actions">
          <button type="submit" id="demographicSubmit">Get demographics</button>
          <button type="button" class="ghost-btn" id="clearBtn">Reset fields</button>
          <div id="formAlert" class="alert hidden"></div>
        </div>
        <div id="loaderBar" class="loader hidden" aria-hidden="true"></div>
      </form>
    </section>

    <section id="editPanel" class="panel hidden">
      <div class="panel-header">
        <div class="panel-title">Step 2 · Review & edit</div>
        <span class="pill" id="autofillBadge">autofill</span>
      </div>
      <div class="stack">
        <div class="field-row">
          <div>
            <label for="editProductUrl">Product URL</label>
            <input type="url" id="editProductUrl" autocomplete="url">
          </div>
          <div>
            <label for="editGender">Gender</label>
            <select id="editGender">
              <option value="">-- select --</option>
              <option value="Any">Any</option>
              <option value="Woman">Woman</option>
              <option value="Man">Man</option>
            </select>
          </div>
        </div>
        <div class="field-row">
          <div>
            <label for="editAgeRange">Age range</label>
            <select id="editAgeRange"></select>
          </div>
          <div>
            <label for="editLanguage">Language(s)</label>
            <input type="text" id="editLanguage" placeholder="English, Spanish">
          </div>
        </div>
        <div class="field-row">
          <div>
            <label for="editLocation">Location(s)</label>
            <input type="text" id="editLocation" placeholder="United States, Europe">
          </div>
          <div>
            <label for="editAudience">Your intent</label>
            <textarea id="editAudience" rows="3" placeholder="Short reminder of what you want to achieve"></textarea>
          </div>
        </div>
        <p class="note">Fields are editable. Languages and locations accept comma-separated lists. Age ranges follow Grok’s allowed bands.</p>
        <div class="actions">
          <button type="button" id="confirmBtn">Confirm target audience</button>
          <div id="editAlert" class="alert hidden"></div>
        </div>
      </div>
    </section>

    <section id="nextModule" class="panel next-module hidden">
      <div class="panel-header">
        <div class="panel-title">Next module</div>
        <span class="pill">queued</span>
      </div>
      <div class="timeline">
        <div class="tile">
          <h4>We’re ready when you are</h4>
          <div class="note">Target audience is pinned above. Tell me what the next module should do and we’ll hook it in.</div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const demographicForm = document.getElementById('demographicForm');
    const demographicSubmit = document.getElementById('demographicSubmit');
    const clearBtn = document.getElementById('clearBtn');
    const loaderBar = document.getElementById('loaderBar');
    const formAlert = document.getElementById('formAlert');
    const editPanel = document.getElementById('editPanel');
    const editAlert = document.getElementById('editAlert');
    const confirmBtn = document.getElementById('confirmBtn');
    const reRunBtn = document.getElementById('reRunBtn');
    const statusChip = document.getElementById('statusChip');
    const pinnedRecap = document.getElementById('pinnedRecap');
    const recapTimeline = document.getElementById('recapTimeline');
    const nextModule = document.getElementById('nextModule');
    const autofillBadge = document.getElementById('autofillBadge');

    const productUrlInput = document.getElementById('productUrl');
    const promptInput = document.getElementById('prompt');
    const editProductUrl = document.getElementById('editProductUrl');
    const editGender = document.getElementById('editGender');
    const editAgeRange = document.getElementById('editAgeRange');
    const editLanguage = document.getElementById('editLanguage');
    const editLocation = document.getElementById('editLocation');
    const editAudience = document.getElementById('editAudience');

    const ageRangeOptions = [
      { label: 'All ages', min: null, max: null },
      { label: '13-24', min: 13, max: 24 },
      { label: '13-34', min: 13, max: 34 },
      { label: '13-49', min: 13, max: 49 },
      { label: '13-54', min: 13, max: 54 },
      { label: '13+', min: 13, max: null },
      { label: '18-24', min: 18, max: 24 },
      { label: '18-34', min: 18, max: 34 },
      { label: '18-49', min: 18, max: 49 },
      { label: '18-54', min: 18, max: 54 },
      { label: '18+', min: 18, max: null },
      { label: '21-34', min: 21, max: 34 },
      { label: '21-49', min: 21, max: 49 },
      { label: '21-54', min: 21, max: 54 },
      { label: '21+', min: 21, max: null },
      { label: '25-49', min: 25, max: 49 },
      { label: '25-54', min: 25, max: 54 },
      { label: '25+', min: 25, max: null },
      { label: '35-49', min: 35, max: 49 },
      { label: '35-54', min: 35, max: 54 },
      { label: '35+', min: 35, max: null },
      { label: '50+', min: 50, max: null }
    ];

    function ageKey(min, max) {
      const left = min === null || min === undefined ? 'null' : String(min);
      const right = max === null || max === undefined ? 'null' : String(max);
      return `${left}-${right}`;
    }

    function hydrateAgeSelect() {
      editAgeRange.innerHTML = '';
      ageRangeOptions.forEach(({ label, min, max }) => {
        const option = document.createElement('option');
        option.value = ageKey(min, max);
        option.textContent = label;
        editAgeRange.appendChild(option);
      });
    }

    function setStatus(text) {
      statusChip.textContent = text;
    }

    function showAlert(el, message, kind = 'error') {
      el.textContent = message;
      el.classList.remove('hidden', 'success', 'error');
      el.classList.add(kind);
    }

    function clearAlert(el) {
      el.textContent = '';
      el.classList.add('hidden');
      el.classList.remove('success', 'error');
    }

    function setLoading(isLoading) {
      if (isLoading) {
        demographicSubmit.disabled = true;
        loaderBar.classList.remove('hidden');
        setStatus('Calling /generate-demographics…');
      } else {
        demographicSubmit.disabled = false;
        loaderBar.classList.add('hidden');
      }
    }

    function ageRangeFromApi(ageRange) {
      if (!ageRange) return ageKey(null, null);
      return ageKey(
        ageRange.min === undefined ? null : ageRange.min,
        ageRange.max === undefined ? null : ageRange.max
      );
    }

    function setEditFields(data, intent) {
      editProductUrl.value = data.product_url || productUrlInput.value.trim();
      editGender.value = data.gender || '';
      editAgeRange.value = ageRangeFromApi(data.age_range);

      const languages = Array.isArray(data.language) ? data.language.join(', ') : '';
      const locations = Array.isArray(data.location) ? data.location.join(', ') : '';

      editLanguage.value = languages;
      editLocation.value = locations;
      editAudience.value = intent || promptInput.value.trim();
    }

    function parseList(input) {
      const value = input.trim();
      if (!value) return null;
      return value.split(',').map(item => item.trim()).filter(Boolean);
    }

    function summarizeSelection(data) {
      const timeline = document.createElement('div');
      timeline.className = 'tile';
      const ageLabel = ageRangeOptions.find(opt => opt.value === ageRangeFromApi(data.age_range))?.label || 'custom';

      timeline.innerHTML = `
        <h4>Target audience locked</h4>
        <div class="chip-row">
          <span>Product: <strong>${data.product_url}</strong></span>
          <span>Gender: <strong>${data.gender || '—'}</strong></span>
          <span>Age: <strong>${ageLabel}</strong></span>
        </div>
        <div class="chip-row">
          <span>Language: <strong>${(data.language || ['—']).join(', ')}</strong></span>
          <span>Location: <strong>${(data.location || ['—']).join(', ')}</strong></span>
        </div>
        ${data.intent ? `<div class="note">Intent: ${data.intent}</div>` : ''}
      `;
      return timeline;
    }

    function scrollToNextModule() {
      nextModule.classList.remove('hidden');
      nextModule.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    demographicForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      clearAlert(formAlert);
      clearAlert(editAlert);

      const productUrl = productUrlInput.value.trim();
      const prompt = promptInput.value.trim();

      if (!productUrl || !prompt) {
        showAlert(formAlert, 'Both fields are required before we can call Grok.');
        return;
      }

      setLoading(true);

      try {
        const response = await fetch('/generate-demographics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_url: productUrl, prompt })
        });

        if (!response.ok) {
          const errorBody = await response.text();
          throw new Error(errorBody || 'Failed to fetch demographics');
        }

        const result = await response.json();
        setEditFields(result, prompt);
        editPanel.classList.remove('hidden');
        autofillBadge.textContent = 'autofill by Grok';
        setStatus('Demographics returned');
      } catch (error) {
        showAlert(formAlert, error.message || 'Unable to fetch demographics right now.');
        setStatus('Error');
      } finally {
        setLoading(false);
      }
    });


    confirmBtn.addEventListener('click', () => {
      clearAlert(editAlert);

      const product_url = editProductUrl.value.trim();
      const gender = editGender.value;
      const [min, max] = editAgeRange.value.split('-');
      const age_range = {
        min: min === 'null' ? null : Number(min),
        max: max === 'null' ? null : Number(max)
      };
      const language = parseList(editLanguage.value);
      const location = parseList(editLocation.value);
      const intent = editAudience.value.trim();

      if (!product_url || !gender) {
        showAlert(editAlert, 'Product URL and gender cannot be empty when confirming.');
        return;
      }

      const finalProfile = { product_url, gender, age_range, language, location, intent };
      recapTimeline.innerHTML = '';
      recapTimeline.appendChild(summarizeSelection(finalProfile));
      pinnedRecap.classList.remove('hidden');
      setStatus('Audience pinned · ready for next module');
      scrollToNextModule();
    });

    reRunBtn.addEventListener('click', () => {
      if (!productUrlInput.value.trim()) {
        productUrlInput.value = editProductUrl.value.trim();
      }
      if (!promptInput.value.trim()) {
        promptInput.value = editAudience.value.trim();
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
      setStatus('Adjust the intent and run again');
    });

    hydrateAgeSelect();
  </script>
</body>
</html>
