<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grok X Ads | Target Audience</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap');

    :root {
      --bg: #0b0b0b;
      --card: #101010;
      --raised: #141414;
      --ink: #f5f5f5;
      --muted: #9b9b9b;
      --border: #1f1f1f;
      --accent: #ffffff;
      --ghost: #191919;
      --shadow: 0 24px 120px rgba(0, 0, 0, 0.45);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at 20% 20%, #111 0%, #0a0a0a 35%, #050505 100%);
      color: var(--ink);
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      min-height: 100vh;
      letter-spacing: -0.01em;
    }

    a {
      color: var(--ink);
      text-decoration: none;
    }

    .frame {
      max-width: 1180px;
      margin: 0 auto;
      padding: 40px 24px 96px;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 32px;
      padding: 16px 0;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }

    .progress-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--ghost);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .step-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 500;
    }

    .step.active .step-number {
      background: var(--accent);
      color: var(--bg);
    }

    .step.active .step-label {
      color: var(--ink);
      font-weight: 600;
    }

    .step.completed .step-number {
      background: var(--accent);
      color: var(--bg);
    }

    .step.completed .step-label {
      color: var(--muted);
    }

    .arrow {
      color: var(--muted);
      font-size: 14px;
      margin: 0 4px;
    }

    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }

    .progress-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--ghost);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .step-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 500;
    }

    .step.active .step-number {
      background: var(--accent);
      color: var(--bg);
    }

    .step.active .step-label {
      color: var(--ink);
      font-weight: 600;
    }

    .step.completed .step-number {
      background: var(--accent);
      color: var(--bg);
    }

    .step.completed .step-label {
      color: var(--muted);
    }

    .step:not(.active):not(.completed) {
      display: none;
    }

    .arrow:has(+ .step:not(.active):not(.completed)) {
      display: none;
    }

    .arrow {
      color: var(--muted);
      font-size: 14px;
      margin: 0 4px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo {
      width: 54px;
      height: 54px;
      background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
      border: 1px solid var(--border);
      border-radius: 14px;
      display: grid;
      place-items: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
    }

    .logo img {
      width: 30px;
      height: 30px;
    }

    .brand-label {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .brand-sub {
      font-size: 16px;
      color: var(--muted);
    }

    .status-chip {
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      font-size: 13px;
      color: var(--muted);
    }

    .panel {
      background: linear-gradient(180deg, var(--raised), #0d0d0d);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 22px 20px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .panel::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.02);
      pointer-events: none;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .panel-title {
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .status-pill {
      margin-left: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--ghost);
      color: var(--ink);
      font-size: 12px;
      min-width: 120px;
      text-align: center;
    }

    .pill {
      font-size: 12px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--ink);
      background: var(--ghost);
    }

    .color-picker-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .color-picker-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-picker-row input[type="color"] {
      width: 48px;
      height: 36px;
      padding: 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--ghost);
    }

    form {
      display: grid;
      gap: 14px;
    }

    label {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .required {
      color: var(--ink);
      font-size: 12px;
      letter-spacing: 0.05em;
    }

    input[type="text"],
    input[type="url"],
    textarea,
    select {
      width: 100%;
      padding: 16px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--ghost);
      color: var(--ink);
      font-size: 17px;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #2d2d2d;
      box-shadow: 0 0 0 1px #2d2d2d;
    }

    textarea {
      resize: vertical;
      min-height: 110px;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      cursor: pointer;
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f9f9f9;
      color: #0b0b0b;
      font-weight: 600;
      font-size: 16px;
      letter-spacing: 0.02em;
      transition: transform 0.12s ease, box-shadow 0.2s ease, border 0.2s ease;
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(255, 255, 255, 0.08);
      border-color: #2a2a2a;
    }

    .ghost-btn {
      background: transparent;
      color: var(--ink);
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .note {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
      margin-top: 6px;
    }

    .hidden {
      display: none;
    }

    .alert {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #121212;
      color: var(--ink);
      font-size: 14px;
      margin-top: 6px;
    }

    .alert.error {
      border-color: #3a3a3a;
      color: #f3b7b7;
    }

    .alert.success {
      border-color: #2d2d2d;
      color: #c9f7c5;
    }

    .stack {
      display: grid;
      gap: 12px;
    }

    .chip-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 13px;
    }

    .chip-row span {
      padding: 6px 10px;
      border-radius: 10px;
      background: var(--ghost);
      border: 1px solid var(--border);
    }

    .monospace {
      font-family: 'IBM Plex Mono', 'SFMono-Regular', Consolas, monospace;
      font-size: 13px;
    }

    .color-pickers {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .color-picker-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 20px;
      background: var(--ghost);
      border: 1px solid var(--border);
    }

    .color-picker-item input[type="color"] {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .color-picker-item input[type="text"] {
      width: 80px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--ink);
      font-size: 12px;
      font-family: 'IBM Plex Mono', monospace;
    }

    .color-picker-item button {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 2px;
      border-radius: 2px;
      font-size: 14px;
      line-height: 1;
    }

    .color-picker-item button:hover {
      color: #f87171;
      background: rgba(248, 113, 113, 0.1);
    }

    .pill-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      min-height: 32px;
      padding: 8px;
      border-radius: 8px;
      background: var(--ghost);
      border: 1px solid var(--border);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      font-size: 14px;
      color: var(--ink);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .pill:hover {
      background: var(--raised);
      border-color: var(--muted);
    }

    .pill.color-pill {
      padding: 6px 8px;
    }

    .pill .color-circle {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid var(--border);
    }

    .pill .remove-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      margin-left: 4px;
      font-size: 16px;
      line-height: 1;
      border-radius: 2px;
    }

    .pill .remove-btn:hover {
      color: #f87171;
      background: rgba(248, 113, 113, 0.1);
    }

    .pill-search {
      width: 100%;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--ghost);
      color: var(--ink);
      font-size: 14px;
    }

    .pill-search:focus {
      outline: none;
      border-color: var(--muted);
    }

    .font-style-display {
      padding: 12px;
      border-radius: 8px;
      background: var(--ghost);
      border: 1px solid var(--border);
      margin-top: 8px;
      font-size: 16px;
      min-height: 20px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }

    .font-style-display:hover {
      border-color: var(--muted);
    }

    .font-options {
      margin-top: 8px;
      border-radius: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      max-height: 200px;
      overflow-y: auto;
    }

    .font-option {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background-color 0.2s ease;
    }

    .font-option:last-child {
      border-bottom: none;
    }

    .font-option:hover {
      background: var(--ghost);
    }

    .timeline {
      display: grid;
      gap: 14px;
      margin-top: 12px;
    }

    .tile {
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #0f0f0f;
      padding: 14px 14px 12px;
    }

    .tile h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      letter-spacing: 0.04em;
      color: var(--muted);
      text-transform: uppercase;
    }

    .tile strong {
      color: var(--ink);
    }

    .next-module {
      border: 1px dashed #2a2a2a;
      background: #0d0d0d;
    }

    .loader {
      width: 100%;
      height: 2px;
      background: #1f1f1f;
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }

    .loader::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, #ffffff, transparent);
      transform: translateX(-100%);
      animation: slide 1.8s infinite;
    }

    @keyframes slide {
      0% { transform: translateX(-100%); }
      50% { transform: translateX(40%); }
      100% { transform: translateX(120%); }
    }

    .editor-wrapper {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .editor-wrapper {
        grid-template-columns: 1fr;
      }
    }

    .canvas-container {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .canvas-wrapper {
      position: relative;
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }

    .text-overlay {
      position: absolute;
      cursor: move;
      user-select: none;
      padding: 16px 24px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(12px);
      border: 2px solid rgba(255, 255, 255, 0.4);
      color: #ffffff;
      font-weight: 700;
      text-align: center;
      min-width: 140px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      z-index: 10;
    }

    .text-overlay:hover {
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .text-overlay.dragging {
      opacity: 0.8;
      cursor: grabbing;
      transform: scale(1.05);
      z-index: 100;
    }

    .text-overlay.slogan {
      font-size: 70px;
      line-height: 1.1;
    }

    .text-overlay.company {
      font-size: 70px;
      line-height: 1.1;
    }

    .color-preview {
      width: 100%;
      height: 40px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-top: 8px;
    }

    @media (max-width: 640px) {
      header {
        align-items: flex-start;
      }
      .actions {
        flex-direction: column;
        align-items: stretch;
      }
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="frame">
    <header class="sticky-header">
      <div class="brand">
        <div class="logo" aria-label="xAI logo">
          <img src="/static/Xicon.jpg" alt="X" loading="lazy">
        </div>
        <div class="brand-label">
          <div class="brand-title">Grok X Ads</div>
          <div class="brand-sub">Product ‚Üí Demographics ‚Üí Brand Style ‚Üí Ad image</div>
        </div>
      </div>
      <div class="progress-indicator">
        <div class="step active" id="step1">
          <span class="step-number">1</span>
          <span class="step-label">Demographics</span>
        </div>
        <div class="arrow">‚Üí</div>
        <div class="step" id="step2">
          <span class="step-number">2</span>
          <span class="step-label">Brand Style</span>
        </div>
        <div class="arrow">‚Üí</div>
        <div class="step" id="step3">
          <span class="step-number">3</span>
          <span class="step-label">Generate</span>
        </div>
        <div class="arrow">‚Üí</div>
        <div class="step" id="step4">
          <span class="step-number">4</span>
          <span class="step-label">Edit</span>
        </div>
        <div class="arrow">‚Üí</div>
        <div class="step" id="step5">
          <span class="step-number">5</span>
          <span class="step-label">Preview</span>
        </div>
      </div>
    </header>

    <section id="pinnedRecap" class="panel hidden">
      <div class="panel-header">
        <div class="panel-title">Pinned target audience</div>
      </div>
      <div class="timeline" id="recapTimeline"></div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Step 1 ¬∑ Get demographics</div>
        <span id="statusPill" class="status-pill" aria-live="polite"></span>
      </div>
      <form id="demographicForm" novalidate>
        <div>
          <label for="productUrl">Product URL <span class="required"></span></label>
          <input type="url" id="productUrl" name="productUrl" placeholder="https://example.com/product" required autocomplete="url">
        </div>
        <div>
          <label for="prompt">Describe this ad's target audience <span class="required"></span></label>
          <textarea id="prompt" name="prompt" placeholder="Who do you want to connect with?" required></textarea>
          <p class="note">Commecting you with your audience.</p>
        </div>
        <div class="actions">
          <button type="submit" id="demographicSubmit">Get demographics</button>
          <div id="formAlert" class="alert hidden"></div>
        </div>
        <div id="loaderBar" class="loader hidden" aria-hidden="true"></div>
      </form>
    </section>

    <section id="editPanel" class="panel hidden">
      <div class="panel-header">
        <div class="panel-title">Step 2 ¬∑ Review & edit demographics</div>
      </div>
      <div class="stack">
        <div class="field-row">
          <div>
            <label for="editProductUrl">Product URL</label>
            <input type="url" id="editProductUrl" autocomplete="url">
          </div>
          <div>
            <label for="editGender">Gender</label>
            <select id="editGender">
              <option value="">-- select --</option>
              <option value="Any">Any</option>
              <option value="Woman">Woman</option>
              <option value="Man">Man</option>
            </select>
          </div>
        </div>
        <div class="field-row">
          <div>
            <label for="editAgeRange">Age range</label>
            <select id="editAgeRange"></select>
          </div>
          <div>
            <label for="editLanguage">Language(s)</label>
            <input type="text" id="editLanguage" placeholder="English, Spanish">
          </div>
        </div>
        <div class="field-row">
          <div>
            <label for="editLocation">Location(s)</label>
            <input type="text" id="editLocation" placeholder="United States, Europe">
          </div>
          <div>
            <label for="editAudience">Your intent</label>
            <textarea id="editAudience" rows="3" placeholder="Short reminder of what you want to achieve"></textarea>
          </div>
        </div>
        <p class="note">Fields are editable. Languages and locations accept comma-separated lists. Age ranges follow Grok's allowed bands.</p>
        <div class="actions">
          <button type="button" id="confirmBtn">Confirm target audience</button>
          <div id="editAlert" class="alert hidden"></div>
        </div>
      </div>
    </section>

    <section id="brandStylePanel" class="panel hidden">
      <div class="panel-header">
        <div class="panel-title">Step 3 ¬∑ Get brand style</div>
      </div>
      <div class="stack">
        <div>
          <label>Brand colors <span class="required"></span></label>
          <div id="colorPills" class="pill-container">
            <!-- Color pills will be dynamically added here -->
          </div>
          <input type="text" id="colorSearch" class="pill-search" placeholder="Search or add color (hex code)">
          <div class="actions" style="margin-top: 8px;">
            <button type="button" class="ghost-btn" id="addColorBtn">Add custom color picker</button>
          </div>
          <div id="colorPickers" class="color-picker-list hidden" aria-live="polite"></div>
        </div>
        <div>
          <label>Brand mood <span class="required"></span></label>
          <div id="moodPills" class="pill-container">
            <!-- Mood pills will be dynamically added here -->
          </div>
          <input type="text" id="moodSearch" class="pill-search" placeholder="Search or add mood">
        </div>
        <div>
          <label>Font style <span class="required"></span></label>
          <div id="fontStyleDisplay" class="font-style-display">Select a font style...</div>
          <input type="text" id="fontSearch" class="pill-search" placeholder="Search font styles">
          <div id="fontOptions" class="font-options hidden">
            <!-- Font options will be populated here -->
          </div>
        </div>
        <div>
          <label for="editSlogan">Slogan</label>
          <input type="text" id="editSlogan" placeholder="Optional tagline or slogan">
        </div>
        <div>
          <label for="editProductDescription">Product description <span class="required"></span></label>
          <textarea id="editProductDescription" rows="4" placeholder="Detailed description of the product/service for ad generation"></textarea>
        </div>
        <p class="note">Click pills to remove them. All fields are editable after auto-analysis.</p>
        <div class="actions">
          <button type="button" id="confirmBrandStyleBtn">Confirm brand style</button>
          <div id="brandStyleAlert" class="alert hidden"></div>
        </div>
        <div id="brandStyleLoader" class="loader hidden" aria-hidden="true"></div>
      </div>
    </section>

    <section id="nextModule" class="panel next-module hidden">
      <div class="panel-header">
        <div class="panel-title">Step 4 ¬∑ Generate ad image</div>
      </div>
      <div class="timeline">
        <div class="tile">
          <h4>Ready to generate ad image</h4>
          <div class="note">Target audience and brand style are confirmed. Click below to generate your ad image.</div>
          <div class="actions" style="margin-top: 12px;">
            <button type="button" id="generateAdBtn">Generate ad image</button>
            <div id="adImageAlert" class="alert hidden"></div>
          </div>
          <div id="adImageLoader" class="loader hidden" aria-hidden="true"></div>
        </div>
      </div>
    </section>

    <section id="editorSection" class="panel hidden">
      <div class="panel-header">
        <div class="panel-title">Step 5 ¬∑ Edit ad image</div>
      </div>
      <div class="editor-wrapper">
        <div class="canvas-container">
          <div class="canvas-wrapper" id="editorCanvasWrapper">
            <img id="editorAdImage" class="ad-image" alt="Generated ad" crossorigin="anonymous" style="display: none;">
            <div id="editorSloganOverlay" class="text-overlay slogan" style="top: 70%; left: 50%; transform: translate(-50%, -50%);"></div>
            <div id="editorCompanyOverlay" class="text-overlay company" style="top: 85%; left: 50%; transform: translate(-50%, -50%);"></div>
          </div>
        </div>

        <div class="sidebar">
          <div class="panel">
            <div class="panel-title">Text Content</div>
            <div class="form-group">
              <label for="editorSloganInput">Slogan</label>
              <input type="text" id="editorSloganInput" placeholder="Enter slogan">
            </div>
            <div class="form-group">
              <label for="editorCompanyInput">Company Name</label>
              <input type="text" id="editorCompanyInput" placeholder="Enter company name">
            </div>
          </div>

          <div class="panel">
            <div class="panel-title">Slogan Style</div>
            <div class="form-group">
              <label for="editorSloganFontSize">Font Size</label>
              <div class="slider-group">
                <input type="range" id="editorSloganFontSize" min="35" max="150" value="70">
                <span class="value-display" id="editorSloganFontSizeValue">70px</span>
              </div>
            </div>
            <div class="form-group">
              <label for="editorSloganColor">Text Color</label>
              <input type="text" id="editorSloganColor" placeholder="#FFFFFF">
              <div class="color-preview" id="editorSloganColorPreview" style="background: #FFFFFF;"></div>
            </div>
            <div class="form-group">
              <label for="editorSloganOpacity">Opacity</label>
              <div class="slider-group">
                <input type="range" id="editorSloganOpacity" min="0" max="100" value="100">
                <span class="value-display" id="editorSloganOpacityValue">100%</span>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-title">Company Style</div>
            <div class="form-group">
              <label for="editorCompanyFontSize">Font Size</label>
              <div class="slider-group">
                <input type="range" id="editorCompanyFontSize" min="35" max="150" value="70">
                <span class="value-display" id="editorCompanyFontSizeValue">70px</span>
              </div>
            </div>
            <div class="form-group">
              <label for="editorCompanyColor">Text Color</label>
              <input type="text" id="editorCompanyColor" placeholder="#FFFFFF">
              <div class="color-preview" id="editorCompanyColorPreview" style="background: #FFFFFF;"></div>
            </div>
            <div class="form-group">
              <label for="editorCompanyOpacity">Opacity</label>
              <div class="slider-group">
                <input type="range" id="editorCompanyOpacity" min="0" max="100" value="100">
                <span class="value-display" id="editorCompanyOpacityValue">100%</span>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="actions">
              <button type="button" id="editorDownloadBtn">Download Edited Image</button>
              <button type="button" class="ghost-btn" id="editorResetBtn">Reset Positions</button>
            </div>
          </div>
        </div>
      </div>
    </section>

  <section id="previewSection" class="panel hidden">
    <div class="panel-header">
      <div class="panel-title">Step 5 ¬∑ Preview (iPhone)</div>
    </div>
    <div class="preview-wrapper">
      <div class="iphone-preview">
        <div class="dynamic-island"></div>
        <div class="screen">
          <div class="status-bar">
            <span class="time">9:41</span>
            <div class="icons">
              <svg width="17" height="11" viewBox="0 0 17 11" fill="none">
                <rect x="0" y="8" width="3" height="3" rx="0.5" fill="#e7e9ea"/>
                <rect x="4.5" y="5.5" width="3" height="5.5" rx="0.5" fill="#e7e9ea"/>
                <rect x="9" y="3" width="3" height="8" rx="0.5" fill="#e7e9ea"/>
                <rect x="13.5" y="0" width="3" height="11" rx="0.5" fill="#e7e9ea"/>
              </svg>
              <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M8 2.4C10.5 2.4 12.8 3.4 14.5 5L16 3.5C13.9 1.3 11.1 0 8 0C4.9 0 2.1 1.3 0 3.5L1.5 5C3.2 3.4 5.5 2.4 8 2.4ZM8 6C9.5 6 10.9 6.6 12 7.5L13.5 6C12 4.7 10.1 4 8 4C5.9 4 4 4.7 2.5 6L4 7.5C5.1 6.6 6.5 6 8 6ZM10 9.5L8 12L6 9.5C6.5 9.2 7.2 9 8 9C8.8 9 9.5 9.2 10 9.5Z" fill="#e7e9ea"/>
              </svg>
              <svg width="25" height="12" viewBox="0 0 25 12" fill="none">
                <rect x="0.5" y="0.5" width="21" height="11" rx="2.5" stroke="#e7e9ea" stroke-opacity="0.4"/>
                <path d="M23 4V8C23.8 7.6 24.5 6.9 24.5 6C24.5 5.1 23.8 4.4 23 4Z" fill="#e7e9ea" fill-opacity="0.4"/>
                <rect x="2" y="2" width="18" height="8" rx="1.5" fill="#e7e9ea"/>
              </svg>
            </div>
          </div>
          <div class="x-header">
            <div class="profile-pic">üç≥</div>
            <svg class="x-logo" viewBox="0 0 24 24" fill="white" width="26" height="26">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            <div></div>
          </div>
          <div class="tabs">
            <div class="tab active">For you</div>
            <div class="tab">Following</div>
          </div>
          <div class="feed" id="previewFeed"></div>
          <div class="bottom-nav">
            <svg viewBox="0 0 24 24"><path d="M21.591 7.146L12.52 1.157c-.316-.21-.724-.21-1.04 0l-9.071 5.99c-.26.173-.409.456-.409.757v13.183c0 .502.418.913.929.913h6.638c.511 0 .929-.41.929-.913v-7.075h3.008v7.075c0 .502.418.913.929.913h6.638c.511 0 .929-.41.929-.913V7.904c0-.301-.158-.584-.418-.758z"/></svg>
            <svg viewBox="0 0 24 24"><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"/></svg>
            <svg viewBox="0 0 24 24"><path d="M18.265 3.314c-3.45-3.45-9.07-3.45-12.52 0-3.45 3.45-3.45 9.07 0 12.52 3.45 3.45 9.07 3.45 12.52 0 3.45-3.45 3.45-9.07 0-12.52zm-1.06 11.46c-2.89 2.89-7.51 2.89-10.4 0-2.89-2.89-2.89-7.51 0-10.4 2.89-2.89 7.51-2.89 10.4 0 2.89 2.89 2.89 7.51 0 10.4zM7.879 14.12l2.465-5.055 5.054-2.466-2.465 5.055-5.054 2.466z"/></svg>
            <svg viewBox="0 0 24 24"><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"/></svg>
            <svg viewBox="0 0 24 24"><path d="M5.651 19h12.698c-.337-1.8-1.023-3.21-1.945-4.19C15.318 13.65 13.838 13 12 13s-3.317.65-4.404 1.81c-.922.98-1.608 2.39-1.945 4.19zm.486-5.56C7.627 11.85 9.648 11 12 11s4.373.85 5.863 2.44c1.477 1.58 2.366 3.8 2.632 6.46l.11 1.1H3.395l.11-1.1c.266-2.66 1.155-4.88 2.632-6.46zM12 4c-1.105 0-2 .9-2 2s.895 2 2 2 2-.9 2-2-.895-2-2-2zM8 6c0-2.21 1.791-4 4-4s4 1.79 4 4-1.791 4-4 4-4-1.79-4-4z"/></svg>
          </div>
        </div>
      </div>
    </div>
  </section>
  </div>

  <script>
    // Utility functions
    const startRotatingMessages = (messages, interval = 2000, delay = 2000) => {
      let messageIndex = 0;
      const statusPill = document.querySelector('.panel-title + span');

      const rotateMessage = () => {
        if (statusPill && messages[messageIndex]) {
          statusPill.textContent = messages[messageIndex];
          messageIndex = (messageIndex + 1) % messages.length;
        }
      };

      // Start after delay
      const delayId = setTimeout(() => {
        rotateMessage();
        // Set up interval
        const intervalId = setInterval(rotateMessage, interval);
        // Store interval ID for cleanup
        statusPill._intervalId = intervalId;
      }, delay);

      // Return function to stop the rotation
      return () => {
        clearTimeout(delayId);
        if (statusPill._intervalId) {
          clearInterval(statusPill._intervalId);
        }
      };
    };

    // Cache DOM elements for performance
    const elements = {
      form: document.getElementById('demographicForm'),
      submit: document.getElementById('demographicSubmit'),
      loader: document.getElementById('loaderBar'),
      formAlert: document.getElementById('formAlert'),
      editPanel: document.getElementById('editPanel'),
      editAlert: document.getElementById('editAlert'),
      confirmBtn: document.getElementById('confirmBtn'),
      brandStylePanel: document.getElementById('brandStylePanel'),
      // brandStyleBadge: document.getElementById('brandStyleBadge'),
      brandStyleAlert: document.getElementById('brandStyleAlert'),
      brandStyleLoader: document.getElementById('brandStyleLoader'),
      confirmBrandStyleBtn: document.getElementById('confirmBrandStyleBtn'),
      reRunBrandStyleBtn: document.getElementById('reRunBrandStyleBtn'),
      productUrl: document.getElementById('productUrl'),
      prompt: document.getElementById('prompt'),
      editProductUrl: document.getElementById('editProductUrl'),
      editGender: document.getElementById('editGender'),
      editAgeRange: document.getElementById('editAgeRange'),
      editLanguage: document.getElementById('editLanguage'),
      editLocation: document.getElementById('editLocation'),
      editAudience: document.getElementById('editAudience'),
      colorPills: document.getElementById('colorPills'),
      colorPickers: document.getElementById('colorPickers'),
      addColorBtn: document.getElementById('addColorBtn'),
      moodPills: document.getElementById('moodPills'),
      fontStyleDisplay: document.getElementById('fontStyleDisplay'),
      fontOptions: document.getElementById('fontOptions'),
      editFontStyle: document.getElementById('fontSearch'),
      fontPreview: document.getElementById('fontPreview'),
      editSlogan: document.getElementById('editSlogan'),
      editProductDescription: document.getElementById('editProductDescription'),
      generateAdBtn: document.getElementById('generateAdBtn'),
      adImageAlert: document.getElementById('adImageAlert'),
      adImageLoader: document.getElementById('adImageLoader'),
      pinnedRecap: document.getElementById('pinnedRecap'),
      recapTimeline: document.getElementById('recapTimeline'),
      nextModule: document.getElementById('nextModule'),
      editorSection: document.getElementById('editorSection'),
      editorAdImage: document.getElementById('editorAdImage'),
      editorSloganOverlay: document.getElementById('editorSloganOverlay'),
      editorCompanyOverlay: document.getElementById('editorCompanyOverlay'),
      editorCanvasWrapper: document.getElementById('editorCanvasWrapper'),
      editorSloganInput: document.getElementById('editorSloganInput'),
      editorCompanyInput: document.getElementById('editorCompanyInput'),
      editorSloganFontSize: document.getElementById('editorSloganFontSize'),
      editorSloganColor: document.getElementById('editorSloganColor'),
      editorSloganOpacity: document.getElementById('editorSloganOpacity'),
      editorCompanyFontSize: document.getElementById('editorCompanyFontSize'),
      editorCompanyColor: document.getElementById('editorCompanyColor'),
      editorCompanyOpacity: document.getElementById('editorCompanyOpacity'),
      editorSloganFontSizeValue: document.getElementById('editorSloganFontSizeValue'),
      editorSloganOpacityValue: document.getElementById('editorSloganOpacityValue'),
      editorSloganColorPreview: document.getElementById('editorSloganColorPreview'),
      editorCompanyFontSizeValue: document.getElementById('editorCompanyFontSizeValue'),
      editorCompanyOpacityValue: document.getElementById('editorCompanyOpacityValue'),
      editorCompanyColorPreview: document.getElementById('editorCompanyColorPreview'),
      editorDownloadBtn: document.getElementById('editorDownloadBtn'),
      editorResetBtn: document.getElementById('editorResetBtn'),
      previewSection: document.getElementById('previewSection'),
      previewFeed: document.getElementById('previewFeed'),
      statusPill: document.getElementById('statusPill')
    };

    const ageRangeOptions = [
      { label: 'All ages', min: null, max: null },
      { label: '13-24', min: 13, max: 24 },
      { label: '13-34', min: 13, max: 34 },
      { label: '13-49', min: 13, max: 49 },
      { label: '13-54', min: 13, max: 54 },
      { label: '13+', min: 13, max: null },
      { label: '18-24', min: 18, max: 24 },
      { label: '18-34', min: 18, max: 34 },
      { label: '18-49', min: 18, max: 49 },
      { label: '18-54', min: 18, max: 54 },
      { label: '18+', min: 18, max: null },
      { label: '21-34', min: 21, max: 34 },
      { label: '21-49', min: 21, max: 49 },
      { label: '21-54', min: 21, max: 54 },
      { label: '21+', min: 21, max: null },
      { label: '25-49', min: 25, max: 49 },
      { label: '25-54', min: 25, max: 54 },
      { label: '25+', min: 25, max: null },
      { label: '35-49', min: 35, max: 49 },
      { label: '35-54', min: 35, max: 54 },
      { label: '35+', min: 35, max: null },
      { label: '50+', min: 50, max: null }
    ];

    // Optimized helper functions
    const ageKey = (min, max) => {
      const left = min == null ? 'null' : String(min);
      const right = max == null ? 'null' : String(max);
      return `${left}-${right}`;
    };

    const ageRangeFromApi = (ageRange) => {
      if (!ageRange) return ageKey(null, null);
      return ageKey(ageRange.min ?? null, ageRange.max ?? null);
    };

    const parseList = (input) => {
      const value = input.trim();
      return value ? value.split(',').map(item => item.trim()).filter(Boolean) : null;
    };

    // Preview (iPhone feed) constants/state
    const PREVIEW_DATA_URL = '/static/iphone/foodie_homechef.jsonl';
    const PREVIEW_BATCH_SIZE = 10;
    const PREVIEW_AD_INTERVAL = 5;
    const previewState = {
      tweets: [],
      index: 0,
      totalPostsRendered: 0,
      promotedImageUrl: null,
      loaded: false,
    };

    // Initialize age select dropdown
    function hydrateAgeSelect() {
      const fragment = document.createDocumentFragment();
      ageRangeOptions.forEach(({ label, min, max }) => {
        const option = document.createElement('option');
        option.value = ageKey(min, max);
        option.textContent = label;
        fragment.appendChild(option);
      });
      elements.editAgeRange.appendChild(fragment);
    }

    // Optimized DOM update functions
    const setLoading = (isLoading) => {
      elements.submit.disabled = isLoading;
      elements.loader.classList.toggle('hidden', !isLoading);
    };

    const showAlert = (el, message, kind = 'error') => {
      el.textContent = message;
      el.className = `alert ${kind}`;
    };

    const clearAlert = (el) => {
      el.textContent = '';
      el.className = 'alert hidden';
    };

    const setEditFields = (data, intent) => {
      // Batch DOM updates
      requestAnimationFrame(() => {
        elements.editProductUrl.value = data.product_url || elements.productUrl.value.trim();
        elements.editGender.value = data.gender || '';
        elements.editAgeRange.value = ageRangeFromApi(data.age_range);
        elements.editLanguage.value = Array.isArray(data.language) ? data.language.join(', ') : '';
        elements.editLocation.value = Array.isArray(data.location) ? data.location.join(', ') : '';
        elements.editAudience.value = intent || elements.prompt.value.trim();
      });
    };

    const summarizeSelection = (data) => {
      const ageLabel = ageRangeOptions.find(opt => opt.value === ageRangeFromApi(data.age_range))?.label || 'custom';
      const timeline = document.createElement('div');
      timeline.className = 'tile';
      timeline.innerHTML = `
        <h4>Target audience locked</h4>
        <div class="chip-row">
          <span>Product: <strong>${data.product_url}</strong></span>
          <span>Gender: <strong>${data.gender || '‚Äî'}</strong></span>
          <span>Age: <strong>${ageLabel}</strong></span>
          <span>Language: <strong>${(data.language || ['‚Äî']).join(', ')}</strong></span>
          <span>Location: <strong>${(data.location || ['‚Äî']).join(', ')}</strong></span>
        </div>
        ${data.intent ? `<div class="note">Intent: ${data.intent}</div>` : ''}
      `;
      return timeline;
    };

    const scrollToNextModule = () => {
      elements.nextModule.classList.remove('hidden');
      requestAnimationFrame(() => {
        elements.nextModule.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    };

    const createPill = (text, type = 'text', color = null) => {
      const pill = document.createElement('span');
      pill.className = `pill ${type === 'color' ? 'color-pill' : ''}`;

      if (type === 'color') {
        const colorCircle = document.createElement('span');
        colorCircle.className = 'color-circle';
        colorCircle.style.backgroundColor = text;
        pill.appendChild(colorCircle);
        pill.appendChild(document.createTextNode(text.toUpperCase()));
      } else {
        pill.textContent = text;
      }

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = '√ó';
      removeBtn.title = 'Remove';

      removeBtn.addEventListener('click', () => {
        pill.remove();
      });

      pill.appendChild(removeBtn);
      return pill;
    };

    const addPillToContainer = (container, text, type = 'text', color = null) => {
      // Check if pill already exists
      const existingPills = container.querySelectorAll('.pill');
      for (const pill of existingPills) {
        const pillText = type === 'color' ? pill.textContent.replace('√ó', '').trim() : pill.textContent.replace('√ó', '').trim();
        if (pillText.toLowerCase() === text.toLowerCase()) {
          return; // Don't add duplicate
        }
      }

      container.appendChild(createPill(text, type, color));
    };

    const getPillsFromContainer = (container) => {
      const pills = [];
      container.querySelectorAll('.pill').forEach(pill => {
        if (pill.classList.contains('color-pill')) {
          // Extract color from pill text (remove √ó and get the hex)
          const text = pill.textContent.replace('√ó', '').trim();
          if (/^#[0-9A-F]{6}$/i.test(text)) {
            pills.push(text);
          }
        } else {
          // Extract text from pill (remove √ó)
          const text = pill.textContent.replace('√ó', '').trim();
          if (text) pills.push(text);
        }
      });
      return pills;
    };

    const setupPillSearch = (searchInput, container, type = 'text', suggestions = []) => {
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const value = searchInput.value.trim();
          if (value) {
            if (type === 'color' && !/^#[0-9A-F]{6}$/i.test(value)) {
              // Invalid color format
              return;
            }
            addPillToContainer(container, value, type);
            searchInput.value = '';
          }
        }
      });

      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        if (query.length > 0 && suggestions.length > 0) {
          const filtered = suggestions.filter(item => item.toLowerCase().includes(query));
          // Could show suggestions here if needed
        }
      });
    };


    const setBrandStyleFields = (data) => {
      requestAnimationFrame(() => {
        // Set color pills
        elements.colorPills.innerHTML = '';
        if (Array.isArray(data.colors)) {
          data.colors.forEach(color => {
            addPillToContainer(elements.colorPills, color, 'color');
          });
        }

        // Set mood pills
        elements.moodPills.innerHTML = '';
        if (data.mood) {
          addPillToContainer(elements.moodPills, data.mood, 'text');
        }

        // Set font style display
        elements.fontStyleDisplay.textContent = data.font_style || 'Select a font style...';
        updateFontDisplay(data.font_style || '');

        elements.editSlogan.value = data.slogan || '';
        elements.editProductDescription.value = data.product_description || '';
      });
    };

    const updateFontDisplay = (fontStyle) => {
      let fontFamily = "'Helvetica Neue', Helvetica, Arial, sans-serif";

      // Map common font style descriptions to actual fonts
      if (fontStyle.toLowerCase().includes('serif')) {
        fontFamily = "'Times New Roman', 'Georgia', serif";
      } else if (fontStyle.toLowerCase().includes('mono') || fontStyle.toLowerCase().includes('tech')) {
        fontFamily = "'Courier New', 'Monaco', monospace";
      } else if (fontStyle.toLowerCase().includes('bold') || fontStyle.toLowerCase().includes('geometric')) {
        fontFamily = "'Arial Black', 'Impact', sans-serif";
      } else if (fontStyle.toLowerCase().includes('playful') || fontStyle.toLowerCase().includes('rounded')) {
        fontFamily = "'Comic Sans MS', cursive";
      } else if (fontStyle.toLowerCase().includes('elegant') || fontStyle.toLowerCase().includes('classic')) {
        fontFamily = "'Georgia', 'Times New Roman', serif";
      }

      elements.fontStyleDisplay.style.fontFamily = fontFamily;
    };

    const populateFontOptions = () => {
      const fontStyles = [
        'Modern Sans-Serif',
        'Elegant Serif',
        'Bold Geometric',
        'Playful Rounded',
        'Minimalist Sans',
        'Classic Serif',
        'Tech Monospace'
      ];

      elements.fontOptions.innerHTML = '';
      fontStyles.forEach(style => {
        const option = document.createElement('div');
        option.className = 'font-option';
        option.textContent = style;
        option.addEventListener('click', () => {
          elements.fontStyleDisplay.textContent = style;
          updateFontDisplay(style);
          elements.fontOptions.classList.add('hidden');
        });
        elements.fontOptions.appendChild(option);
      });
    };

    const setBrandStyleLoading = (isLoading) => {
      elements.confirmBrandStyleBtn.disabled = isLoading;
      elements.brandStyleLoader.classList.toggle('hidden', !isLoading);
      // elements.brandStyleBadge.textContent = isLoading ? 'analyzing' : 'autofill';
    };

    const createColorPicker = (value = '#ffffff') => {
      const row = document.createElement('div');
      row.className = 'color-picker-row';

      const picker = document.createElement('input');
      picker.type = 'color';
      picker.value = value;

      const hexInput = document.createElement('input');
      hexInput.type = 'text';
      hexInput.placeholder = '#FFFFFF';
      hexInput.value = value;
      hexInput.className = 'pill-search';
      hexInput.style.flex = '1';

      const syncValue = (val) => {
        if (!/^#([0-9a-fA-F]{3}){1,2}$/.test(val)) return;
        picker.value = val;
        hexInput.value = val.toUpperCase();
      };

      picker.addEventListener('input', (e) => syncValue(e.target.value));
      hexInput.addEventListener('input', (e) => syncValue(e.target.value.trim()));

      row.appendChild(picker);
      row.appendChild(hexInput);
      return row;
    };

    const updateFontPreview = (event) => {
      const query = event.target.value.trim().toLowerCase();
      const options = Array.from(elements.fontOptions.children);
      if (!options.length) return;

      let anyVisible = false;
      options.forEach(option => {
        const match = option.textContent.toLowerCase().includes(query);
        option.style.display = query ? (match ? '' : 'none') : '';
        if (match) anyVisible = true;
      });

      elements.fontOptions.classList.toggle('hidden', !query && !anyVisible);
      if (query && anyVisible) {
        elements.fontOptions.classList.remove('hidden');
      }
    };
    // Optimized fetch with abort controller and keepalive
    let currentController = null;
    let currentBrandStyleController = null;

    const callBrandStyleAPI = async (productUrl) => {
      clearAlert(elements.brandStyleAlert);
      setBrandStyleLoading(true);

      if (currentBrandStyleController) {
        currentBrandStyleController.abort();
      }

      currentBrandStyleController = new AbortController();

      // Start rotating messages for brand style analysis
      const stopRotating = startRotatingMessages([
        'Scanning website design...',
        'Extracting brand colors...',
        'Analyzing visual style...',
        'Crafting brand profile...'
      ]);

      try {
        const startTime = performance.now();

        const response = await fetch('/analyze-brand-style', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ product_url: productUrl }),
          signal: currentBrandStyleController.signal,
          keepalive: true,
          priority: 'high'
        });

        if (!response.ok) {
          const errorBody = await response.text();
          throw new Error(errorBody || 'Failed to analyze brand style');
        }

        const result = await response.json();
        const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);

        setBrandStyleFields(result);
        elements.brandStylePanel.classList.remove('hidden');
        updateProgressIndicator(2); // Stay on step 2 while analyzing

        console.log(`Brand style API call completed in ${elapsed}s`);
      } catch (error) {
        if (error.name === 'AbortError') {
          return;
        }
        showAlert(elements.brandStyleAlert, error.message || 'Unable to analyze brand style right now.');
        console.error('Brand style API error:', error);
      } finally {
        setBrandStyleLoading(false);
        currentBrandStyleController = null;
        stopRotating(); // Stop rotating messages
      }
    };

    elements.form.addEventListener('submit', async (event) => {
      event.preventDefault();
      clearAlert(elements.formAlert);
      clearAlert(elements.editAlert);

      const productUrl = elements.productUrl.value.trim();
      const prompt = elements.prompt.value.trim();

      if (!productUrl || !prompt) {
        showAlert(elements.formAlert, 'Both fields are required before we can call Grok.');
        return;
      }

      // Abort any pending request
      if (currentController) {
        currentController.abort();
      }

      currentController = new AbortController();
      setLoading(true);

      // Start rotating messages
      const stopRotating = startRotatingMessages([
        'Analyzing your product...',
        'Finding ideal customers...',
        'Building demographics profile...',
        'Almost ready...'
      ]);

      try {
        const startTime = performance.now();

        const response = await fetch('/generate-demographics', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ product_url: productUrl, prompt }),
          signal: currentController.signal,
          keepalive: true,
          priority: 'high'
        });

        if (!response.ok) {
          const errorBody = await response.text();
          throw new Error(errorBody || 'Failed to fetch demographics');
        }

        const result = await response.json();
        const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);

        setEditFields(result, prompt);
        elements.editPanel.classList.remove('hidden');
        updateProgressIndicator(2); // Move to step 2
        console.log(`API call completed in ${elapsed}s`);
      } catch (error) {
        if (error.name === 'AbortError') {
          return; // User cancelled, don't show error
        }
        showAlert(elements.formAlert, error.message || 'Unable to fetch demographics right now.');
        console.error('Demographics API error:', error);
      } finally {
        setLoading(false);
        currentController = null;
        stopRotating(); // Stop rotating messages
      }
    });


    elements.confirmBtn.addEventListener('click', async () => {
      clearAlert(elements.editAlert);

      const product_url = elements.editProductUrl.value.trim();
      const gender = elements.editGender.value;
      const [min, max] = elements.editAgeRange.value.split('-');
      const age_range = {
        min: min === 'null' ? null : Number(min),
        max: max === 'null' ? null : Number(max)
      };
      const language = parseList(elements.editLanguage.value);
      const location = parseList(elements.editLocation.value);
      const intent = elements.editAudience.value.trim();

      if (!product_url || !gender) {
        showAlert(elements.editAlert, 'Product URL and gender cannot be empty when confirming.');
        return;
      }

      const finalProfile = { product_url, gender, age_range, language, location, intent };
      elements.recapTimeline.innerHTML = '';
      elements.recapTimeline.appendChild(summarizeSelection(finalProfile));
      elements.pinnedRecap.classList.remove('hidden');

      // Store demographics for later use
      localStorage.setItem('finalDemographics', JSON.stringify(finalProfile));


      // Auto-call brand style API after confirming demographics
      await callBrandStyleAPI(product_url);
    });


    elements.confirmBrandStyleBtn.addEventListener('click', () => {
      clearAlert(elements.brandStyleAlert);

      const colors = getPillsFromContainer(elements.colorPills);
      const mood = getPillsFromContainer(elements.moodPills);
      const fontStyle = elements.fontStyleDisplay.textContent === 'Select a font style...' ? '' : elements.fontStyleDisplay.textContent;
      const slogan = elements.editSlogan.value.trim() || null;
      const productDescription = elements.editProductDescription.value.trim();

      if (!colors || colors.length === 0 || !mood || mood.length === 0 || !fontStyle || !productDescription) {
        showAlert(elements.brandStyleAlert, 'Colors, mood, font style, and product description are required.');
        return;
      }

      // Store brand style data for later use
      window.brandStyleData = {
        colors,
        mood: mood[0], // Take first mood
        fontStyle,
        slogan,
        productDescription
      };

      // Show the next module (ad image generation)
      scrollToNextModule();
      updateProgressIndicator(3); // Move to step 3
    });


    elements.generateAdBtn.addEventListener('click', async () => {
      clearAlert(elements.adImageAlert);
      elements.adImageLoader.classList.remove('hidden');
      elements.generateAdBtn.disabled = true;

      try {
        const demographics = JSON.parse(localStorage.getItem('finalDemographics') || '{}');
        const brandStyle = window.brandStyleData;

        // Convert age_range object back to string format
        let ageRangeStr = null;
        if (demographics.age_range) {
          const { min, max } = demographics.age_range;
          if (min === null && max === null) {
            ageRangeStr = 'All';
          } else if (min === null) {
            ageRangeStr = `${max}-`;
          } else if (max === null) {
            ageRangeStr = `${min}+`;
          } else {
            ageRangeStr = `${min}-${max}`;
          }
        }

        const requestData = {
          product_url: demographics.product_url,
          gender: demographics.gender,
          age_range: ageRangeStr,
          language: demographics.language?.join(', ') || null,
          location: demographics.location?.join(', ') || null,
          colors: brandStyle.colors,
          mood: brandStyle.mood,
          product_description: brandStyle.productDescription
        };

        const response = await fetch('/generate-ad-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });

        if (!response.ok) {
          throw new Error('Failed to generate ad image');
        }

        const result = await response.json();

        // Display the generated image and initialize editor
        const imageContainer = document.createElement('div');
        imageContainer.innerHTML = `
          <h4>Generated Ad Image</h4>
          <img src="${result.image_url}" alt="Generated ad" style="max-width: 100%; border-radius: 12px; margin-top: 12px;">
          <p class="note" style="margin-top: 8px;">Prompt used: ${result.prompt_used}</p>
          <div class="actions" style="margin-top: 12px;">
            <button type="button" id="editImageBtn">Edit Image</button>
            <button type="button" id="previewAdBtn">Preview on iPhone</button>
          </div>
        `;

        // Replace the generate button area with the image and edit button
        const tile = elements.nextModule.querySelector('.tile');
        tile.innerHTML = imageContainer.innerHTML;

        // Cache preview image URL
        window.previewImageUrl = result.image_url;
        previewState.promotedImageUrl = result.image_url;

        // Add event listener to the edit button
        document.getElementById('editImageBtn').addEventListener('click', () => {
          initializeEditor(
            result.image_url,
            window.brandStyleData?.slogan || '',
            '',
            window.brandStyleData?.colors || []
          );
        });

        // Add event listener to preview button
        document.getElementById('previewAdBtn').addEventListener('click', () => {
          showPreview();
        });

      } catch (error) {
        showAlert(elements.adImageAlert, error.message || 'Failed to generate ad image.');
      } finally {
        elements.adImageLoader.classList.add('hidden');
        elements.generateAdBtn.disabled = false;
      }
    });

    // Progress indicator functions
    function updateProgressIndicator(currentStep) {
      // Reset all steps
      for (let i = 1; i <= 5; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (stepEl) {
          stepEl.classList.remove('active', 'completed');
        }
      }

      // Set current step as active
      const currentStepEl = document.getElementById(`step${currentStep}`);
      if (currentStepEl) {
        currentStepEl.classList.add('active');
      }

      // Set previous steps as completed
      for (let i = 1; i < currentStep; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (stepEl) {
          stepEl.classList.remove('active');
          stepEl.classList.add('completed');
        }
      }
    }

    // Initialize on page load
    hydrateAgeSelect();
    updateProgressIndicator(1); // Start with step 1 active

    // Color picker functionality
    if (elements.addColorBtn && elements.colorPickers) {
      elements.addColorBtn.addEventListener('click', () => {
        elements.colorPickers.appendChild(createColorPicker());
        elements.colorPickers.classList.remove('hidden');
      });
    }

    // Font preview update
    if (elements.editFontStyle) {
      elements.editFontStyle.addEventListener('input', updateFontPreview);
    }

    // Editor event listeners
    elements.editorSloganInput.addEventListener('input', (e) => {
      elements.editorSloganOverlay.textContent = e.target.value;
    });

    elements.editorCompanyInput.addEventListener('input', (e) => {
      elements.editorCompanyOverlay.textContent = e.target.value;
    });

    elements.editorSloganFontSize.addEventListener('input', (e) => {
      const size = e.target.value;
      elements.editorSloganFontSizeValue.textContent = `${size}px`;
      elements.editorSloganOverlay.style.fontSize = `${size}px`;
    });

    elements.editorSloganColor.addEventListener('input', (e) => {
      const color = e.target.value;
      if (isValidColor(color)) {
        elements.editorSloganColorPreview.style.background = color;
        elements.editorSloganOverlay.style.color = color;
      }
    });

    elements.editorSloganOpacity.addEventListener('input', (e) => {
      const opacity = e.target.value;
      elements.editorSloganOpacityValue.textContent = `${opacity}%`;
      elements.editorSloganOverlay.style.opacity = opacity / 100;
    });

    elements.editorCompanyFontSize.addEventListener('input', (e) => {
      const size = e.target.value;
      elements.editorCompanyFontSizeValue.textContent = `${size}px`;
      elements.editorCompanyOverlay.style.fontSize = `${size}px`;
    });

    elements.editorCompanyColor.addEventListener('input', (e) => {
      const color = e.target.value;
      if (isValidColor(color)) {
        elements.editorCompanyColorPreview.style.background = color;
        elements.editorCompanyOverlay.style.color = color;
      }
    });

    elements.editorCompanyOpacity.addEventListener('input', (e) => {
      const opacity = e.target.value;
      elements.editorCompanyOpacityValue.textContent = `${opacity}%`;
      elements.editorCompanyOverlay.style.opacity = opacity / 100;
    });

    elements.editorResetBtn.addEventListener('click', () => {
      elements.editorSloganOverlay.style.top = '70%';
      elements.editorSloganOverlay.style.left = '50%';
      elements.editorCompanyOverlay.style.top = '85%';
      elements.editorCompanyOverlay.style.left = '50%';
      elements.editorSloganOverlay.style.transform = 'translate(-50%, -50%)';
      elements.editorCompanyOverlay.style.transform = 'translate(-50%, -50%)';
    });

    // ---------- Step 5 Preview (iPhone feed) ----------
    const previewInitials = (name = '') => {
      const parts = name.trim().split(/\s+/).filter(Boolean);
      if (!parts.length) return 'üç≥';
      return parts.slice(0, 2).map(p => p[0]).join('').toUpperCase();
    };

    const previewTimeAgo = (dateStr) => {
      if (!dateStr) return '';
      const now = new Date();
      const date = new Date(dateStr);
      const diff = Math.floor((now - date) / 1000);
      if (diff < 60) return `${diff}s`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
      return `${Math.floor(diff / 86400)}d`;
    };

    const escapeHtml = (text) => {
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    };

    const previewGetMedia = (tweet, mediaMap) => {
      const keys = tweet.attachments?.media_keys || [];
      for (const key of keys) {
        const media = mediaMap.get(key);
        if (!media) continue;
        if (media.type === 'photo' && media.url) return { type: 'photo', url: media.url };
        if (media.type === 'video' && Array.isArray(media.variants)) {
          const mp4s = media.variants
            .filter(v => v.content_type === 'video/mp4' && v.url)
            .sort((a, b) => (b.bit_rate || 0) - (a.bit_rate || 0));
          if (mp4s.length) return { type: 'video', url: mp4s[0].url };
        }
      }
      return null;
    };

    async function loadPreviewData() {
      if (previewState.loaded) return;
      const res = await fetch(PREVIEW_DATA_URL);
      if (!res.ok) throw new Error('Failed to load preview data');
      const raw = await res.text();
      const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
      const collected = [];

      for (let i = 0; i < Math.min(lines.length, PREVIEW_BATCH_SIZE); i++) {
        try {
          const entry = JSON.parse(lines[i]);
          const tweet = entry.tweet;
          if (!tweet) continue;
          const mediaMap = new Map();
          (entry.includes?.media || []).forEach(m => mediaMap.set(m.media_key, m));
          const users = entry.includes?.users || [];
          const author = users.find(u => u.id === tweet.author_id) || {};
          collected.push({
            id: tweet.id,
            text: tweet.text || '',
            authorName: author.name || 'Foodie',
            authorHandle: author.username ? `@${author.username}` : '@foodie',
            createdAt: tweet.created_at,
            media: previewGetMedia(tweet, mediaMap),
          });
        } catch (err) {
          console.warn('Skip bad preview line', i, err);
        }
      }

      previewState.tweets = collected;
      previewState.loaded = true;
    }

    const createPreviewCard = (tweet) => {
      const card = document.createElement('div');
      card.className = 'tweet';
      const avatarBg = 'linear-gradient(135deg, #ff6b6b, #feca57)';
      let mediaHtml = '';
      if (tweet.media) {
        if (tweet.media.type === 'photo') {
          mediaHtml = `<div class="tweet-media"><img src="${tweet.media.url}" alt="tweet media" loading="lazy"></div>`;
        } else if (tweet.media.type === 'video') {
          mediaHtml = `<div class="tweet-media"><video src="${tweet.media.url}" controls playsinline preload="metadata"></video></div>`;
        }
      }
      card.innerHTML = `
        <div class="tweet-avatar" style="background:${avatarBg}">${previewInitials(tweet.authorName)}</div>
        <div class="tweet-content">
          <div class="tweet-header">
            <span class="tweet-name">${escapeHtml(tweet.authorName)}</span>
            <span class="tweet-handle">${escapeHtml(tweet.authorHandle)}</span>
            <span class="tweet-time">${previewTimeAgo(tweet.createdAt)}</span>
          </div>
          <div class="tweet-text">${escapeHtml(tweet.text)}</div>
          ${mediaHtml}
          <div class="tweet-actions">
            <div class="action reply">üí¨ <span>12</span></div>
            <div class="action retweet">üîÅ <span>34</span></div>
            <div class="action like">‚ù§Ô∏è <span>128</span></div>
            <div class="action views">üëÅÔ∏è <span>2.4K</span></div>
          </div>
        </div>
      `;
      return card;
    };

    const createPromotedPreviewCard = (text) => {
      const card = document.createElement('div');
      card.className = 'tweet promoted';
      const imgSrc = previewState.promotedImageUrl || '';
      const mediaHtml = imgSrc
        ? `<div class="tweet-media"><img src="${imgSrc}" alt="Ad image"></div>`
        : `<div class="tweet-media" style="height:200px;display:grid;place-items:center;color:#71767b;">Generate the ad first to preview</div>`;
      card.innerHTML = `
        <div class="tweet-avatar" style="background:linear-gradient(135deg,#f59e0b,#ef4444)">üî•</div>
        <div class="tweet-content">
          <div class="tweet-header">
            <span class="tweet-name">Foodie Brands</span>
            <span class="tweet-handle">@FoodieBrands</span>
            <span class="tweet-time">Promoted</span>
          </div>
          <div class="promoted-badge">Promoted</div>
          <div class="tweet-text">${escapeHtml(text || 'Your ad goes here')}</div>
          ${mediaHtml}
          <div class="tweet-actions">
            <div class="action reply">üí¨ <span>18</span></div>
            <div class="action retweet">üîÅ <span>52</span></div>
            <div class="action like">‚ù§Ô∏è <span>210</span></div>
            <div class="action views">üëÅÔ∏è <span>5.1K</span></div>
          </div>
        </div>
      `;
      return card;
    };

    function renderPreviewBatch() {
      if (!previewState.tweets.length) return;
      const feed = elements.previewFeed;
      for (let i = 0; i < PREVIEW_BATCH_SIZE; i++) {
        const tweet = previewState.tweets[previewState.index];
        previewState.index = (previewState.index + 1) % previewState.tweets.length;
        const card = createPreviewCard(tweet);
        feed.appendChild(card);
        previewState.totalPostsRendered++;
        if (previewState.totalPostsRendered % PREVIEW_AD_INTERVAL === 0) {
          const promotedCard = createPromotedPreviewCard(tweet.text);
          feed.appendChild(promotedCard);
          previewState.totalPostsRendered++;
        }
      }
    }

    async function showPreview() {
      await loadPreviewData();
      previewState.promotedImageUrl = window.previewImageUrl || previewState.promotedImageUrl;
      previewState.index = 0;
      previewState.totalPostsRendered = 0;
      elements.previewFeed.innerHTML = '';
      renderPreviewBatch();
      elements.previewSection.classList.remove('hidden');
      updateProgressIndicator(5);
      const onScrollPreview = () => {
        const { scrollTop, scrollHeight, clientHeight } = elements.previewFeed;
        if (scrollHeight - scrollTop - clientHeight < 200) {
          renderPreviewBatch();
        }
      };
      elements.previewFeed.addEventListener('scroll', onScrollPreview);
      elements.previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    elements.editorDownloadBtn.addEventListener('click', async () => {
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = elements.editorAdImage;

        // Wait for image to load
        if (!img.complete) {
          await new Promise((resolve) => {
            img.onload = resolve;
          });
        }

        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;

        // Draw image
        ctx.drawImage(img, 0, 0);

        // Draw slogan
        const sloganRect = elements.editorSloganOverlay.getBoundingClientRect();
        const wrapperRect = elements.editorCanvasWrapper.getBoundingClientRect();
        const scaleX = canvas.width / wrapperRect.width;
        const scaleY = canvas.height / wrapperRect.height;

        const sloganX = (sloganRect.left - wrapperRect.left + sloganRect.width / 2) * scaleX;
        const sloganY = (sloganRect.top - wrapperRect.top + sloganRect.height / 2) * scaleY;

        ctx.save();
        ctx.globalAlpha = parseFloat(elements.editorSloganOverlay.style.opacity || 1);
        ctx.fillStyle = elements.editorSloganOverlay.style.color || '#FFFFFF';
        ctx.font = `${elements.editorSloganFontSize.value}px ${elements.editorSloganOverlay.style.fontFamily || 'Arial, sans-serif'}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(elements.editorSloganOverlay.textContent, sloganX, sloganY);
        ctx.restore();

        // Draw company name
        const companyRect = elements.editorCompanyOverlay.getBoundingClientRect();
        const companyX = (companyRect.left - wrapperRect.left + companyRect.width / 2) * scaleX;
        const companyY = (companyRect.top - wrapperRect.top + companyRect.height / 2) * scaleY;

        ctx.save();
        ctx.globalAlpha = parseFloat(elements.editorCompanyOverlay.style.opacity || 1);
        ctx.fillStyle = elements.editorCompanyOverlay.style.color || '#FFFFFF';
        ctx.font = `${elements.editorCompanyFontSize.value}px ${elements.editorCompanyOverlay.style.fontFamily || 'Arial, sans-serif'}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(elements.editorCompanyOverlay.textContent, companyX, companyY);
        ctx.restore();

        // Download
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'edited-ad-image.png';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      } catch (error) {
        alert('Failed to download image: ' + error.message);
        console.error(error);
      }
    });

    // Editor functionality
    let editorDraggedElement = null;
    let editorOffset = { x: 0, y: 0 };

    function makeEditorDraggable(element) {
      element.addEventListener('mousedown', (e) => {
        if (e.target === element || element.contains(e.target)) {
          editorDraggedElement = element;
          const rect = element.getBoundingClientRect();
          const wrapperRect = elements.editorCanvasWrapper.getBoundingClientRect();
          editorOffset.x = e.clientX - rect.left - rect.width / 2;
          editorOffset.y = e.clientY - rect.top - rect.height / 2;
          element.classList.add('dragging');
          e.preventDefault();
        }
      });
    }

    document.addEventListener('mousemove', (e) => {
      if (editorDraggedElement) {
        const wrapperRect = elements.editorCanvasWrapper.getBoundingClientRect();
        const wrapperWidth = wrapperRect.width;
        const wrapperHeight = wrapperRect.height;
        const elementRect = editorDraggedElement.getBoundingClientRect();

        let x = e.clientX - wrapperRect.left - editorOffset.x;
        let y = e.clientY - wrapperRect.top - editorOffset.y;

        // Constrain to canvas bounds
        x = Math.max(elementRect.width / 2, Math.min(x, wrapperWidth - elementRect.width / 2));
        y = Math.max(elementRect.height / 2, Math.min(y, wrapperHeight - elementRect.height / 2));

        const percentX = (x / wrapperWidth) * 100;
        const percentY = (y / wrapperHeight) * 100;

        editorDraggedElement.style.left = `${percentX}%`;
        editorDraggedElement.style.top = `${percentY}%`;
        editorDraggedElement.style.transform = 'translate(-50%, -50%)';
      }
    });

    document.addEventListener('mouseup', () => {
      if (editorDraggedElement) {
        editorDraggedElement.classList.remove('dragging');
        editorDraggedElement = null;
      }
    });

    function isValidColor(color) {
      const s = new Option().style;
      s.color = color;
      return s.color !== '';
    }

    function initializeEditor(imageUrl, slogan, company, colors) {
      // Set image
      elements.editorAdImage.onload = () => {
        elements.editorAdImage.style.display = 'block';
        updateEditorCanvasSize();
      };

      elements.editorAdImage.src = `/proxy-image?image_url=${encodeURIComponent(imageUrl)}`;

      // Auto-populate company name if not provided
      if (!company) {
        const demographics = JSON.parse(localStorage.getItem('finalDemographics') || '{}');
        const productUrl = demographics.product_url || '';
        // Extract domain name as company name
        try {
          const url = new URL(productUrl);
          company = url.hostname.replace('www.', '').split('.')[0];
          company = company.charAt(0).toUpperCase() + company.slice(1);
        } catch (e) {
          company = 'Your Brand';
        }
      }

      // Set text content
      elements.editorSloganInput.value = slogan || '';
      elements.editorCompanyInput.value = company || '';
      elements.editorSloganOverlay.textContent = slogan || '';
      elements.editorCompanyOverlay.textContent = company || '';

      // Set font family from brand style
      const fontStyle = window.brandStyleData?.fontStyle || 'Modern Sans-Serif';
      let fontFamily = "'Helvetica Neue', Helvetica, Arial, sans-serif";

      // Map common font style descriptions to actual fonts
      if (fontStyle.toLowerCase().includes('serif')) {
        fontFamily = "'Times New Roman', 'Georgia', serif";
      } else if (fontStyle.toLowerCase().includes('mono') || fontStyle.toLowerCase().includes('tech')) {
        fontFamily = "'Courier New', 'Monaco', monospace";
      } else if (fontStyle.toLowerCase().includes('bold') || fontStyle.toLowerCase().includes('geometric')) {
        fontFamily = "'Arial Black', 'Impact', sans-serif";
      } else if (fontStyle.toLowerCase().includes('playful') || fontStyle.toLowerCase().includes('rounded')) {
        fontFamily = "'Comic Sans MS', cursive";
      } else if (fontStyle.toLowerCase().includes('elegant') || fontStyle.toLowerCase().includes('classic')) {
        fontFamily = "'Georgia', 'Times New Roman', serif";
      }

      elements.editorSloganOverlay.style.fontFamily = fontFamily;
      elements.editorCompanyOverlay.style.fontFamily = fontFamily;

      // Set colors
      if (colors && colors.length > 0) {
        elements.editorSloganColor.value = colors[0];
        elements.editorSloganColorPreview.style.background = colors[0];
        elements.editorSloganOverlay.style.color = colors[0];

        if (colors.length > 1) {
          elements.editorCompanyColor.value = colors[1];
          elements.editorCompanyColorPreview.style.background = colors[1];
          elements.editorCompanyOverlay.style.color = colors[1];
        }
      }

      // Make overlays draggable
      makeEditorDraggable(elements.editorSloganOverlay);
      makeEditorDraggable(elements.editorCompanyOverlay);

      // Show editor
      elements.editorSection.classList.remove('hidden');
      updateProgressIndicator(4); // Move to step 4
      requestAnimationFrame(() => {
        elements.editorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }

    function updateEditorCanvasSize() {
      const img = elements.editorAdImage;
      if (img.complete && img.naturalWidth > 0) {
        elements.editorCanvasWrapper.style.width = '100%';
        elements.editorCanvasWrapper.style.maxWidth = `${img.naturalWidth}px`;
      }
    }
  </script>
</body>
</html>

