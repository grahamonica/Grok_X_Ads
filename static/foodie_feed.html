<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Foodie Feed · iPhone View</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #10b981;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: radial-gradient(circle at 20% 20%, #1e293b, #0f172a 45%);
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      color: var(--text);
    }
    .phone {
      position: relative;
      width: 390px;
      height: 780px;
      padding: 18px 14px 24px;
      border-radius: 38px;
      background: linear-gradient(160deg, #0b1224, #101826 50%, #0b1224);
      box-shadow:
        0 25px 60px rgba(0, 0, 0, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.06),
        inset 0 -1px 0 rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .notch {
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      width: 160px;
      height: 28px;
      border-radius: 18px;
      background: #0b1220;
      box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.08);
    }
    .screen {
      position: relative;
      margin-top: 28px;
      height: 710px;
      overflow-y: auto;
      padding: 10px 6px 24px;
      border-radius: 26px;
      background: #0e1525;
      scroll-behavior: smooth;
    }
    .header {
      position: sticky;
      top: 0;
      z-index: 2;
      padding: 10px 12px;
      background: rgba(14, 21, 37, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header img {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid var(--border);
    }
    .header h1 {
      margin: 0;
      font-size: 15px;
      letter-spacing: 0.3px;
    }
    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-left: auto;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      margin: 12px 6px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    }
    .tweet-head {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: linear-gradient(135deg, #10b981, #22d3ee);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: #0b1220;
    }
    .meta {
      font-size: 12px;
      color: var(--muted);
    }
    .tweet-text {
      font-size: 14px;
      line-height: 1.45;
      margin: 4px 0 10px;
      color: #e5e7eb;
      white-space: pre-wrap;
    }
    .media {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin: 8px 0;
      overflow: hidden;
    }
    .media img {
      width: 100%;
      display: block;
      object-fit: cover;
      max-height: 220px;
    }
    .ad-block {
      border: 1px dashed #1f2937;
      border-radius: 12px;
      padding: 10px;
      background: #0b1220;
      display: grid;
      gap: 8px;
    }
    .ad-status {
      font-size: 12px;
      color: var(--muted);
    }
    .ad-img {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      min-height: 140px;
      background: linear-gradient(135deg, #0f172a, #111827);
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .ad-img.loaded {
      opacity: 1;
    }
    .footer-space { height: 24px; }
    .sentinel {
      width: 100%;
      height: 1px;
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #1f2937;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 6px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .error {
      color: #f87171;
    }
  </style>
</head>
<body>
  <div class="phone">
    <div class="notch"></div>
    <div class="screen" id="screen">
      <div class="header">
        <img src="/static/Xicon.jpg" alt="Logo" />
        <h1>Foodie Homechef</h1>
        <div class="hint">Infinite scroll</div>
      </div>
      <div id="feed"></div>
      <div class="sentinel" id="sentinel"></div>
      <div class="footer-space"></div>
    </div>
  </div>

  <script>
    const feedEl = document.getElementById("feed");
    const sentinel = document.getElementById("sentinel");
    const screenEl = document.getElementById("screen");

    const state = {
      offset: 0,
      limit: 10,
      loading: false,
      queue: [],
      queueRunning: false,
    };

    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

    const formatDate = (iso) => {
      if (!iso) return "";
      const d = new Date(iso);
      return d.toLocaleString(undefined, { month: "short", day: "numeric" });
    };

    function renderCard(item) {
      const card = document.createElement("div");
      card.className = "card";

      const initial = (item.author_name || item.author_username || "X")[0].toUpperCase();
      const username = item.author_username ? `@${item.author_username}` : "anon";

      card.innerHTML = `
        <div class="tweet-head">
          <div class="avatar">${initial}</div>
          <div>
            <div class="meta">${item.author_name || "Unknown"}</div>
            <div class="meta">${username} · ${formatDate(item.created_at)}</div>
          </div>
        </div>
        <div class="tweet-text">${(item.text || "").replace(/</g, "&lt;")}</div>
      `;

      if (item.media_url) {
        const mediaWrap = document.createElement("div");
        mediaWrap.className = "media";
        mediaWrap.innerHTML = `<img src="${item.media_url}" alt="Tweet media" loading="lazy" />`;
        card.appendChild(mediaWrap);
      }

      const ad = document.createElement("div");
      ad.className = "ad-block";
      ad.innerHTML = `
        <div class="ad-status"><span class="spinner"></span>Generating ad image…</div>
        <img class="ad-img" alt="Ad image" />
      `;
      card.appendChild(ad);

      feedEl.appendChild(card);

      const statusEl = ad.querySelector(".ad-status");
      const imgEl = ad.querySelector(".ad-img");
      enqueueImage(item, imgEl, statusEl);
    }

    function enqueueImage(item, imgEl, statusEl) {
      state.queue.push({ item, imgEl, statusEl });
      runQueue();
    }

    async function runQueue() {
      if (state.queueRunning) return;
      state.queueRunning = true;
      while (state.queue.length) {
        const { item, imgEl, statusEl } = state.queue.shift();
        try {
          statusEl.innerHTML = `<span class="spinner"></span>Generating ad image…`;
          const payload = {
            product_url: item.product_url,
            product_description: item.text || "",
          };
          const res = await fetch("/generate-ad-image", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          imgEl.src = data.image_url;
          imgEl.classList.add("loaded");
          statusEl.textContent = "";
        } catch (err) {
          statusEl.textContent = "Ad unavailable";
          statusEl.classList.add("error");
        }
        // Small delay to avoid hammering the API
        await sleep(400);
      }
      state.queueRunning = false;
    }

    async function loadMore() {
      if (state.loading) return;
      state.loading = true;
      try {
        const res = await fetch(`/api/foodie-feed?offset=${state.offset}&limit=${state.limit}`);
        if (!res.ok) throw new Error("Failed to load feed");
        const data = await res.json();
        (data.items || []).forEach(renderCard);
        if (typeof data.next_offset === "number") {
          state.offset = data.next_offset;
        } else {
          state.offset = (state.offset + state.limit) % Math.max(data.total || 1, 1);
        }
      } catch (err) {
        console.error(err);
      } finally {
        state.loading = false;
      }
    }

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) loadMore();
        });
      },
      { root: screenEl, threshold: 0.1 }
    );

    observer.observe(sentinel);
    loadMore();
  </script>
</body>
</html>

