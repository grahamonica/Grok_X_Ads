<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>X - Foodie Feed</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    :root {
      --bg: #000000;
      --surface: #000000;
      --border: #2f3336;
      --text-primary: #e7e9ea;
      --text-secondary: #71767b;
      --accent: #1d9bf0;
      --accent-hover: #1a8cd8;
      --like: #f91880;
      --retweet: #00ba7c;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    /* iPhone 15 Pro Frame */
    .iphone {
      width: 393px;
      height: 852px;
      background: #1c1c1e;
      border-radius: 55px;
      padding: 12px;
      box-shadow: 
        0 0 0 1px rgba(255,255,255,0.1),
        0 50px 100px -20px rgba(0,0,0,0.5),
        0 30px 60px -30px rgba(0,0,0,0.6),
        inset 0 0 0 2px #2c2c2e;
      position: relative;
    }
    
    /* Dynamic Island */
    .dynamic-island {
      position: absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      width: 126px;
      height: 37px;
      background: #000;
      border-radius: 20px;
      z-index: 100;
    }
    
    /* Side buttons */
    .iphone::before {
      content: '';
      position: absolute;
      right: -3px;
      top: 180px;
      width: 4px;
      height: 95px;
      background: #3a3a3c;
      border-radius: 0 2px 2px 0;
    }
    
    .screen {
      width: 100%;
      height: 100%;
      background: var(--bg);
      border-radius: 47px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* Status Bar */
    .status-bar {
      height: 54px;
      padding: 14px 28px 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background: var(--bg);
      position: relative;
      z-index: 10;
    }
    
    .status-bar .time {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .status-bar .icons {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    
    /* X Header */
    .x-header {
      padding: 8px 16px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    
    .x-header .profile-pic {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: white;
    }
    
    .x-header .x-logo {
      width: 28px;
      height: 28px;
    }
    
    .x-header .premium-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    
    .tab {
      flex: 1;
      padding: 14px 0;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      color: var(--text-secondary);
      position: relative;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .tab.active {
      color: var(--text-primary);
      font-weight: 700;
    }
    
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 56px;
      height: 4px;
      background: var(--accent);
      border-radius: 2px;
    }
    
    /* Feed */
    .feed {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      scroll-behavior: smooth;
    }
    
    .feed::-webkit-scrollbar {
      width: 0;
    }
    
    /* Tweet Card */
    .tweet {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }
    
    .tweet-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b6b, #feca57);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: white;
    }
    
    .tweet-content {
      flex: 1;
      min-width: 0;
    }
    
    .tweet-header {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
      margin-bottom: 2px;
    }
    
    .tweet-name {
      font-weight: 700;
      font-size: 15px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    
    .verified {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }
    
    .tweet-handle {
      font-size: 15px;
      color: var(--text-secondary);
    }
    
    .tweet-time {
      font-size: 15px;
      color: var(--text-secondary);
    }
    
    .tweet-time::before {
      content: '¬∑';
      margin: 0 4px;
    }
    
    .tweet-text {
      font-size: 15px;
      line-height: 1.4;
      color: var(--text-primary);
      margin-bottom: 12px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    
    /* Ad Image */
    .tweet-media {
      border-radius: 16px;
      overflow: hidden;
      background: #16181c;
      aspect-ratio: 16/9;
      margin-bottom: 12px;
      position: relative;
    }
    
    .tweet-media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    
    .tweet-media img.loaded {
      opacity: 1;
    }
    
    .tweet-media .loader {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: linear-gradient(135deg, #16181c, #1e2028);
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .loader-text {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .tweet-media .error {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: #16181c;
      color: var(--text-secondary);
      font-size: 13px;
    }
    
    /* Video in tweets */
    .tweet-video {
      aspect-ratio: auto;
    }
    
    .tweet-video video {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      background: #000;
    }
    
    /* Promoted tweet styling */
    .tweet.promoted {
      background: rgba(29, 155, 240, 0.03);
      border-left: 3px solid var(--accent);
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Promoted badge */
    .promoted-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    
    .promoted-badge svg {
      width: 14px;
      height: 14px;
      fill: var(--text-secondary);
    }
    
    /* Actions */
    .tweet-actions {
      display: flex;
      justify-content: space-between;
      max-width: 300px;
    }
    
    .action {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .action svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }
    
    .action:hover {
      color: var(--accent);
    }
    
    .action.like:hover {
      color: var(--like);
    }
    
    .action.retweet:hover {
      color: var(--retweet);
    }
    
    /* Bottom Nav */
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      padding: 10px 0 30px;
      background: var(--bg);
      border-top: 1px solid var(--border);
    }
    
    .nav-item {
      padding: 8px;
      cursor: pointer;
    }
    
    .nav-item svg {
      width: 26px;
      height: 26px;
      fill: var(--text-primary);
    }
    
    .nav-item.active svg {
      fill: var(--text-primary);
    }
    
    /* FAB */
    .fab {
      position: absolute;
      bottom: 90px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(29, 155, 240, 0.4);
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
    }
    
    .fab:hover {
      background: var(--accent-hover);
      transform: scale(1.05);
    }
    
    .fab svg {
      width: 24px;
      height: 24px;
      fill: white;
    }
  </style>
</head>
<body>
  <div class="iphone">
    <div class="dynamic-island"></div>
    <div class="screen">
      <!-- Status Bar -->
      <div class="status-bar">
        <span class="time">9:41</span>
        <div class="icons">
          <!-- Cellular (iOS style) -->
          <svg width="17" height="11" viewBox="0 0 17 11" fill="none">
            <rect x="0" y="8" width="3" height="3" rx="0.5" fill="#e7e9ea"/>
            <rect x="4.5" y="5.5" width="3" height="5.5" rx="0.5" fill="#e7e9ea"/>
            <rect x="9" y="3" width="3" height="8" rx="0.5" fill="#e7e9ea"/>
            <rect x="13.5" y="0" width="3" height="11" rx="0.5" fill="#e7e9ea"/>
          </svg>
          <!-- WiFi (iOS style) -->
          <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M8 2.4C10.5 2.4 12.8 3.4 14.5 5L16 3.5C13.9 1.3 11.1 0 8 0C4.9 0 2.1 1.3 0 3.5L1.5 5C3.2 3.4 5.5 2.4 8 2.4ZM8 6C9.5 6 10.9 6.6 12 7.5L13.5 6C12 4.7 10.1 4 8 4C5.9 4 4 4.7 2.5 6L4 7.5C5.1 6.6 6.5 6 8 6ZM10 9.5L8 12L6 9.5C6.5 9.2 7.2 9 8 9C8.8 9 9.5 9.2 10 9.5Z" fill="#e7e9ea"/>
          </svg>
          <!-- Battery (iOS style) -->
          <svg width="25" height="12" viewBox="0 0 25 12" fill="none">
            <rect x="0.5" y="0.5" width="21" height="11" rx="2.5" stroke="#e7e9ea" stroke-opacity="0.4"/>
            <path d="M23 4V8C23.8 7.6 24.5 6.9 24.5 6C24.5 5.1 23.8 4.4 23 4Z" fill="#e7e9ea" fill-opacity="0.4"/>
            <rect x="2" y="2" width="18" height="8" rx="1.5" fill="#e7e9ea"/>
          </svg>
        </div>
      </div>
      
      <!-- X Header -->
      <div class="x-header">
        <div class="profile-pic">üç≥</div>
        <svg class="x-logo" viewBox="0 0 24 24" fill="white">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
        <button class="premium-btn">Upgrade</button>
      </div>
      
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active">For you</div>
        <div class="tab">Following</div>
      </div>
      
      <!-- Feed -->
      <div class="feed" id="feed"></div>
      
      <!-- FAB -->
      <div class="fab">
        <svg viewBox="0 0 24 24"><path d="M23 3c-6.62-.1-10.38 2.421-13.05 6.03C7.29 12.61 6 17.331 6 22h2c0-1.007.07-2.012.19-3H12c4.1 0 7.48-3.082 7.94-7.054C22.79 10.147 23.17 6.359 23 3zm-7 8h-1.5v2H16c.63-.016 1.2-.08 1.72-.188C16.95 15.24 14.68 17 12 17H8.55c.57-2.512 1.57-4.851 3-6.78 2.16-2.912 5.29-4.911 9.45-5.187C20.95 8.079 19.9 11 16 11zM4 9V6H1V4h3V1h2v3h3v2H6v3H4z"/></svg>
      </div>
      
      <!-- Bottom Nav -->
      <div class="bottom-nav">
        <div class="nav-item active">
          <svg viewBox="0 0 24 24"><path d="M21.591 7.146L12.52 1.157c-.316-.21-.724-.21-1.04 0l-9.071 5.99c-.26.173-.409.456-.409.757v13.183c0 .502.418.913.929.913h6.638c.511 0 .929-.41.929-.913v-7.075h3.008v7.075c0 .502.418.913.929.913h6.638c.511 0 .929-.41.929-.913V7.904c0-.301-.158-.584-.418-.758z"/></svg>
        </div>
        <div class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"/></svg>
        </div>
        <div class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M18.265 3.314c-3.45-3.45-9.07-3.45-12.52 0-3.45 3.45-3.45 9.07 0 12.52 3.45 3.45 9.07 3.45 12.52 0 3.45-3.45 3.45-9.07 0-12.52zm-1.06 11.46c-2.89 2.89-7.51 2.89-10.4 0-2.89-2.89-2.89-7.51 0-10.4 2.89-2.89 7.51-2.89 10.4 0 2.89 2.89 2.89 7.51 0 10.4zM7.879 14.12l2.465-5.055 5.054-2.466-2.465 5.055-5.054 2.466z"/></svg>
        </div>
        <div class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"/></svg>
        </div>
        <div class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M5.651 19h12.698c-.337-1.8-1.023-3.21-1.945-4.19C15.318 13.65 13.838 13 12 13s-3.317.65-4.404 1.81c-.922.98-1.608 2.39-1.945 4.19zm.486-5.56C7.627 11.85 9.648 11 12 11s4.373.85 5.863 2.44c1.477 1.58 2.366 3.8 2.632 6.46l.11 1.1H3.395l.11-1.1c.266-2.66 1.155-4.88 2.632-6.46zM12 4c-1.105 0-2 .9-2 2s.895 2 2 2 2-.9 2-2-.895-2-2-2zM8 6c0-2.21 1.791-4 4-4s4 1.79 4 4-1.791 4-4 4-4-1.79-4-4z"/></svg>
        </div>
      </div>
    </div>
  </div>

  <script>
    const DATA_URL = "foodie_homechef.jsonl";
    const PRODUCT_URL = "https://example.com";
    const MAX_TWEETS = 10;
    const PROMOTED_INDEX = 2; // Insert promoted ad every 5th post (0-indexed: 0,1,2,3,4 = 5th)
    const feedEl = document.getElementById("feed");

    const state = {
      tweets: [],
      promotedTweet: null,
      promotedImageUrl: null, // Cache the generated ad image
      index: 0,
      batchCount: 0,
      totalPostsRendered: 0, // Track total posts to insert ad every 5th
    };

    // Get initials from name
    function getInitials(name = "") {
      const parts = name.trim().split(/\s+/).filter(Boolean);
      if (!parts.length) return "üç≥";
      return parts.slice(0, 2).map(p => p[0]).join("").toUpperCase();
    }

    // Format time ago
    function timeAgo(dateStr) {
      if (!dateStr) return "";
      const now = new Date();
      const date = new Date(dateStr);
      const diff = Math.floor((now - date) / 1000);
      
      if (diff < 60) return `${diff}s`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
      return `${Math.floor(diff / 86400)}d`;
    }

    // Extract media URL from tweet using includes.media
    function getMediaUrl(tweet, mediaMap) {
      const mediaKeys = tweet.attachments?.media_keys || [];
      for (const key of mediaKeys) {
        const media = mediaMap.get(key);
        if (!media) continue;
        // Photo
        if (media.type === "photo" && media.url) {
          return { type: "photo", url: media.url };
        }
        // Video - get best quality mp4
        if (media.type === "video" && Array.isArray(media.variants)) {
          const mp4s = media.variants
            .filter(v => v.content_type === "video/mp4" && v.url)
            .sort((a, b) => (b.bit_rate || 0) - (a.bit_rate || 0));
          if (mp4s.length) {
            return { type: "video", url: mp4s[0].url };
          }
        }
      }
      return null;
    }

    // Load first 10 main tweets from JSONL
    async function loadData() {
      const res = await fetch(DATA_URL);
      if (!res.ok) throw new Error("Failed to load dataset");
      
      const raw = await res.text();
      const lines = raw.split("\n").map(l => l.trim()).filter(Boolean);
      const collected = [];

      // Only take the first MAX_TWEETS lines
      for (let i = 0; i < Math.min(lines.length, MAX_TWEETS); i++) {
        try {
          const entry = JSON.parse(lines[i]);
          const tweet = entry.tweet;
          if (!tweet) continue;

          // Build media map from includes.media
          const mediaMap = new Map();
          (entry.includes?.media || []).forEach(m => mediaMap.set(m.media_key, m));

          // Find author from includes.users
          const users = entry.includes?.users || [];
          const author = users.find(u => u.id === tweet.author_id) || {};

          // Get media URL if available
          const media = getMediaUrl(tweet, mediaMap);

          collected.push({
            id: tweet.id,
            text: tweet.text || "",
            authorName: author.name || "Foodie",
            authorHandle: author.username ? `@${author.username}` : "@foodie",
            createdAt: tweet.created_at,
            media: media, // { type: 'photo'|'video', url: '...' } or null
            metrics: tweet.public_metrics || {},
          });
        } catch (err) {
          console.warn("Skip bad line", i, err);
        }
      }

      state.tweets = collected;
      
      // Create a promoted tweet (use first tweet's text for generating ad)
      if (collected.length > 0) {
        const baseTweet = collected[0];
        state.promotedTweet = {
          id: "promoted-" + baseTweet.id,
          text: baseTweet.text,
          authorName: "Foodie Brands",
          authorHandle: "@FoodieBrands",
          createdAt: new Date().toISOString(),
          isPromoted: true,
        };
      }

      if (!state.tweets.length) throw new Error("No tweets found");
    }

    // Create regular tweet card (with existing media)
    function createTweetCard(tweet) {
      const card = document.createElement("div");
      card.className = "tweet";

      const avatarColors = [
        "linear-gradient(135deg, #ff6b6b, #feca57)",
        "linear-gradient(135deg, #5f27cd, #341f97)",
        "linear-gradient(135deg, #00d2d3, #01a3a4)",
        "linear-gradient(135deg, #ff9f43, #ee5253)",
        "linear-gradient(135deg, #10ac84, #1dd1a1)",
        "linear-gradient(135deg, #54a0ff, #2e86de)",
      ];
      const avatarBg = avatarColors[Math.floor(Math.random() * avatarColors.length)];

      const metrics = tweet.metrics || {};
      const replies = metrics.reply_count || Math.floor(Math.random() * 20);
      const retweets = metrics.retweet_count || Math.floor(Math.random() * 50);
      const likes = metrics.like_count || Math.floor(Math.random() * 200);
      const views = metrics.impression_count ? 
        (metrics.impression_count >= 1000 ? Math.round(metrics.impression_count / 1000) + "K" : metrics.impression_count) :
        Math.floor(Math.random() * 30 + 1) + "K";

      // Build media HTML
      let mediaHtml = "";
      if (tweet.media) {
        if (tweet.media.type === "photo") {
          mediaHtml = `
            <div class="tweet-media">
              <img src="${tweet.media.url}" alt="Tweet image" class="loaded">
            </div>
          `;
        } else if (tweet.media.type === "video") {
          mediaHtml = `
            <div class="tweet-media tweet-video">
              <video src="${tweet.media.url}" controls playsinline preload="metadata"></video>
            </div>
          `;
        }
      }

      card.innerHTML = `
        <div class="tweet-avatar" style="background: ${avatarBg}">${getInitials(tweet.authorName)}</div>
        <div class="tweet-content">
          <div class="tweet-header">
            <span class="tweet-name">${escapeHtml(tweet.authorName)}</span>
            <svg class="verified" viewBox="0 0 22 22" fill="#1d9bf0">
              <path d="M20.396 11c-.018-.646-.215-1.275-.57-1.816-.354-.54-.852-.972-1.438-1.246.223-.607.27-1.264.14-1.897-.131-.634-.437-1.218-.882-1.687-.47-.445-1.053-.75-1.687-.882-.633-.13-1.29-.083-1.897.14-.273-.587-.704-1.086-1.245-1.44S11.647 1.62 11 1.604c-.646.017-1.273.213-1.813.568s-.969.854-1.24 1.44c-.608-.223-1.267-.272-1.902-.14-.635.13-1.22.436-1.69.882-.445.47-.749 1.055-.878 1.688-.13.633-.08 1.29.144 1.896-.587.274-1.087.705-1.443 1.245-.356.54-.555 1.17-.574 1.817.02.647.218 1.276.574 1.817.356.54.856.972 1.443 1.245-.224.606-.274 1.263-.144 1.896.13.634.433 1.218.877 1.688.47.443 1.054.747 1.687.878.633.132 1.29.084 1.897-.136.274.586.705 1.084 1.246 1.439.54.354 1.17.551 1.816.569.647-.016 1.276-.213 1.817-.567s.972-.854 1.245-1.44c.604.239 1.266.296 1.903.164.636-.132 1.22-.447 1.68-.907.46-.46.776-1.044.908-1.681s.075-1.299-.165-1.903c.586-.274 1.084-.705 1.439-1.246.354-.54.551-1.17.569-1.816zM9.662 14.85l-3.429-3.428 1.293-1.302 2.072 2.072 4.4-4.794 1.347 1.246z"/>
            </svg>
            <span class="tweet-handle">${escapeHtml(tweet.authorHandle)}</span>
            <span class="tweet-time">${timeAgo(tweet.createdAt)}</span>
          </div>
          <div class="tweet-text">${escapeHtml(tweet.text)}</div>
          ${mediaHtml}
          <div class="tweet-actions">
            <div class="action reply">
              <svg viewBox="0 0 24 24"><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"/></svg>
              <span>${replies}</span>
            </div>
            <div class="action retweet">
              <svg viewBox="0 0 24 24"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"/></svg>
              <span>${retweets}</span>
            </div>
            <div class="action like">
              <svg viewBox="0 0 24 24"><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"/></svg>
              <span>${likes}</span>
            </div>
            <div class="action views">
              <svg viewBox="0 0 24 24"><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"/></svg>
              <span>${views}</span>
            </div>
            <div class="action share">
              <svg viewBox="0 0 24 24"><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.3 3.3-1.41-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"/></svg>
            </div>
          </div>
        </div>
      `;

      return card;
    }

    // Create PROMOTED ad card (with Grok-generated image)
    function createPromotedCard(tweet) {
      const card = document.createElement("div");
      card.className = "tweet promoted";

      card.innerHTML = `
        <div class="tweet-avatar" style="background: linear-gradient(135deg, #f59e0b, #ef4444)">üî•</div>
        <div class="tweet-content">
          <div class="tweet-header">
            <span class="tweet-name">${escapeHtml(tweet.authorName)}</span>
            <svg class="verified" viewBox="0 0 22 22" fill="#e6b800">
              <path d="M20.396 11c-.018-.646-.215-1.275-.57-1.816-.354-.54-.852-.972-1.438-1.246.223-.607.27-1.264.14-1.897-.131-.634-.437-1.218-.882-1.687-.47-.445-1.053-.75-1.687-.882-.633-.13-1.29-.083-1.897.14-.273-.587-.704-1.086-1.245-1.44S11.647 1.62 11 1.604c-.646.017-1.273.213-1.813.568s-.969.854-1.24 1.44c-.608-.223-1.267-.272-1.902-.14-.635.13-1.22.436-1.69.882-.445.47-.749 1.055-.878 1.688-.13.633-.08 1.29.144 1.896-.587.274-1.087.705-1.443 1.245-.356.54-.555 1.17-.574 1.817.02.647.218 1.276.574 1.817.356.54.856.972 1.443 1.245-.224.606-.274 1.263-.144 1.896.13.634.433 1.218.877 1.688.47.443 1.054.747 1.687.878.633.132 1.29.084 1.897-.136.274.586.705 1.084 1.246 1.439.54.354 1.17.551 1.816.569.647-.016 1.276-.213 1.817-.567s.972-.854 1.245-1.44c.604.239 1.266.296 1.903.164.636-.132 1.22-.447 1.68-.907.46-.46.776-1.044.908-1.681s.075-1.299-.165-1.903c.586-.274 1.084-.705 1.439-1.246.354-.54.551-1.17.569-1.816zM9.662 14.85l-3.429-3.428 1.293-1.302 2.072 2.072 4.4-4.794 1.347 1.246z"/>
            </svg>
            <span class="tweet-handle">${escapeHtml(tweet.authorHandle)}</span>
          </div>
          <div class="promoted-badge">
            <svg viewBox="0 0 24 24"><path d="M19.498 3h-15c-1.381 0-2.5 1.12-2.5 2.5v13c0 1.38 1.119 2.5 2.5 2.5h15c1.381 0 2.5-1.12 2.5-2.5v-13c0-1.38-1.119-2.5-2.5-2.5zm-3.502 12h-2v-3.59l-5.293 5.3-1.414-1.42L12.581 10H8.998V8h7v7z"/></svg>
            Promoted
          </div>
          <div class="tweet-text">${escapeHtml(tweet.text)}</div>
          <div class="tweet-media">
            <img alt="Promoted ad image">
            <div class="loader">
              <div class="spinner"></div>
              <span class="loader-text">Generating ad...</span>
            </div>
            <div class="error">Image unavailable</div>
          </div>
          <div class="tweet-actions">
            <div class="action reply">
              <svg viewBox="0 0 24 24"><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"/></svg>
              <span>12</span>
            </div>
            <div class="action retweet">
              <svg viewBox="0 0 24 24"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"/></svg>
              <span>45</span>
            </div>
            <div class="action like">
              <svg viewBox="0 0 24 24"><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"/></svg>
              <span>128</span>
            </div>
            <div class="action views">
              <svg viewBox="0 0 24 24"><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"/></svg>
              <span>2.4K</span>
            </div>
            <div class="action share">
              <svg viewBox="0 0 24 24"><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.3 3.3-1.41-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"/></svg>
            </div>
          </div>
        </div>
      `;

      // Use cached image or fetch from Grok API
      const img = card.querySelector("img");
      const loader = card.querySelector(".loader");
      const error = card.querySelector(".error");

      if (state.promotedImageUrl) {
        // Use cached image
        img.src = state.promotedImageUrl;
        img.onload = () => img.classList.add("loaded");
        loader.style.display = "none";
      } else {
        // Fetch and cache the image
        fetchAndCacheAdImage(tweet.text, img, loader, error);
      }

      return card;
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    async function fetchAndCacheAdImage(tweetText, imgEl, loaderEl, errorEl) {
      try {
        const res = await fetch("/generate-ad-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            product_url: PRODUCT_URL,
            product_description: tweetText,
          }),
        });

        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        if (!data.image_url) throw new Error("No image URL");

        // Cache the image URL for future use
        state.promotedImageUrl = data.image_url;

        imgEl.src = data.image_url;
        imgEl.onload = () => {
          imgEl.classList.add("loaded");
          loaderEl.style.display = "none";
        };
        imgEl.onerror = () => {
          loaderEl.style.display = "none";
          errorEl.style.display = "flex";
        };
      } catch (err) {
        console.error("Image fetch error:", err);
        loaderEl.style.display = "none";
        errorEl.style.display = "flex";
      }
    }

    // Render batch of tweets with promoted ad every 5th post
    function renderBatch() {
      if (!state.tweets.length) return;

      state.batchCount++;

      for (let i = 0; i < state.tweets.length; i++) {
        const tweet = state.tweets[state.index];
        state.index = (state.index + 1) % state.tweets.length;
        
        // Add regular tweet
        const card = createTweetCard(tweet);
        feedEl.appendChild(card);
        state.totalPostsRendered++;

        // Insert promoted ad every 5th post
        if (state.totalPostsRendered % 5 === 0 && state.promotedTweet) {
          const promotedCard = createPromotedCard(state.promotedTweet);
          feedEl.appendChild(promotedCard);
          state.totalPostsRendered++; // Count the ad as a post too
        }
      }
    }

    // Infinite scroll handler
    function onScroll() {
      const { scrollTop, scrollHeight, clientHeight } = feedEl;
      if (scrollHeight - scrollTop - clientHeight < 200) {
        renderBatch();
      }
    }

    // Start the app
    async function start() {
      try {
        await loadData();
        renderBatch();
        feedEl.addEventListener("scroll", onScroll);
      } catch (err) {
        feedEl.innerHTML = `<div style="padding: 20px; color: #ef4444; text-align: center;">${err.message}</div>`;
      }
    }

    start();
  </script>
</body>
</html>
